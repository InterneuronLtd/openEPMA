<!--BEGIN LICENSE BLOCK--> 
<!--Interneuron Terminus

Copyright(C) 2025  Interneuron Limited

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.If not, see<http://www.gnu.org/licenses/>. -->
<!--END LICENSE BLOCK--> 
<div id="pform" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog  modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="card-header pt-2 pb-2" *ngIf="formsettings && formsettings.medication">
                <div class="row pl-1 text-break">{{ptitle}} - {{formsettings.medication.name}}</div>
                <div *ngIf="appService.refWeightValue" class="small font-italic row">
                    <div class="col text-right">
                        <p class="mb-n1">
                            Reference weight<span
                                *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">
                                (Estimated)</span>
                            <span *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">
                                (Actual)</span>:
                            <strong>{{appService.refWeightValue}} kg</strong>
                            -
                            Ideal body weight:
                            <strong *ngIf="appService.idealWeightValue!=-1">{{appService.idealWeightValue}} kg</strong>
                            <strong *ngIf="appService.idealWeightValue==-1">N/A</strong>
                            -
                            Body surface: <strong>{{appService.bodySurfaceArea}} m<sup>2</sup></strong>
                        </p>
                    </div>
                </div>
                <!-- <button type="button" class="close" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button> -->
            </div>
            <div class="modal-body p-0 pt-1">
                <!-- <div class="card-header" style="padding:0.8em" *ngIf="formsettings && formsettings.medication">
                Prescription - {{formsettings.medication.name}}
            </div> -->
                <div *ngIf="formsettings && formsettings.medication && formsettings.medication.detail.prescribable">
                    <form id="f1" [formGroup]="prescription" (ngSubmit)="AddToTherapyList()" autocomplete="off">
                        <div
                            [hidden]="iseditingvariable || iseditingprotocol || iseditinginfusionvariable || iseditingchosendays || iseditingadditionalconditions || iseditinglinkedinfusion">
                            <div style="width:100%; padding:24px; padding-bottom:5px; padding-top:1px" #formtop>
                                <div class="row">
                                    <div class="col-xs-12" style="width: 90%;">
                                        <label for="txtname" hidden>Medication name:</label>
                                        <input style="height: 30px; font-size: 85%;" formControlName="name" enterIsNext
                                            class="form-control font-weight-bold" id="txtname" readonly />
                                    </div>
                                    <div class="col-xs-12 p-3 druginfo_image" (click)="showDrugInfo()">

                                    </div>
                                </div>
                                <!-- route row  -->
                                <div class="row">
                                    <div class="col-xs-12 headerlabeldiv text-muted">
                                        <label>
                                            <span>Route(s)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="row mt-1">
                                    <div *ngIf="formsettings.medication.productType.toLowerCase() !='custom'"
                                        [ngClass]="{'col-xs-12':true, 'ck-button':true, 'border rounded border-danger':IsRouteValid()}">
                                        <label *ngFor="let rt of formsettings.routes"
                                            [ngClass]="{'primaryroute':rt.isPrimary, 'unlicensedroute':rt.isunlicensed}">
                                            <input
                                                [disabled]="(editingPrescription && clonePrescription!=true && formContext == 'ip') || formsettings.routes.length ==1"
                                                type="checkbox" [checked]="rt.isChecked"
                                                (change)="RouteChanged($event,rt)" [id]="rt.routecode"
                                                [value]="rt.routecode" #routecheckbox>
                                            <span>{{rt.route}}</span>
                                        </label>
                                    </div>

                                    <div [ngClass]="{'col-xs-12':true}"
                                        *ngIf="formsettings.medication.productType.toLowerCase() =='custom'">
                                        <table class="table-sm">
                                            <tr *ngFor="let r of formsettings.routes">

                                                <td [ngClass]="{'primaryroute':r.isPrimary}" *ngIf="r.isPrimary">
                                                    {{r.route}}
                                                    <i (click)="RouteChanged(false,r)" class="float-right">✖</i>
                                                </td>

                                            </tr>
                                            <tr *ngFor="let r of formsettings.routes">
                                                <td [ngClass]="{'primaryroute':r.isPrimary}"
                                                    *ngIf="r.isChecked && !r.isPrimary">
                                                    {{r.route}} <i (click)="RouteChanged(false,r)"
                                                        class="float-right">✖</i>
                                                </td>

                                            </tr>
                                        </table>
                                        <input placeholder="Search Routes" [ngClass]=" {'border rounded
                                    border-danger':IsRouteValid()}" [(ngModel)]="customRouteSelectedModel"
                                            [ngModelOptions]="{standalone: true}" [typeahead]="formsettings.routes"
                                            typeaheadOptionField="route"
                                            (typeaheadOnSelect)="RouteChanged(true,$event.item)" class="form-control">
                                    </div>
                                    <div *ngIf="formsettings.isPrimaryRouteIV && !isDoseSizeRange && (formsettings.medication.detail.doseFormCd == '1' || formsettings.medication.detail.doseFormCd == null) "
                                        [hidden]="formsettings.isOxygen || formContext == 'op'"
                                        [ngClass]="{'col-xs-12':true, 'ck-button':true, 'border rounded border-danger':IsInfusionTypeValid()}">
                                        <label>
                                            <input formControlName="infusiontype" (click)="ClearInfusionType('ci')"
                                                type="radio" id="ci" value="ci"><span>Continuous
                                                Infusion</span>
                                        </label>
                                        <label *ngIf="!prescription['controls'].titration.value">
                                            <input formControlName="infusiontype" (click)="ClearInfusionType('bolus')"
                                                type="radio" id="bolus" value="bolus"><span>Bolus</span>
                                        </label>
                                        <label *ngIf="!prescription['controls'].titration.value">
                                            <input formControlName="infusiontype" (click)="ClearInfusionType('rate')"
                                                type="radio" id="rate" value="rate"><span>Intermittent</span>
                                        </label>
                                        <label *ngIf="!prescription['controls'].titration.value && showPca">
                                            <input formControlName="infusiontype" (click)="ClearInfusionType('pca')"
                                                type="radio" id="pca" value="pca"><span>PCA/NCA</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <table style="width: 90%;">
                                        <tr>
                                            <td class="float-left">
                                                <!-- dose row  -->
                                                <div *ngIf="(formsettings.isInfusion || formsettings.interval_type == 'standard')"
                                                    class="row">
                                                    <div class="col-xs-12 headerlabeldiv  text-muted">
                                                        <label>
                                                            <span>Dose</span>
                                                            <span
                                                                *ngIf="formsettings.roundingfactor > 0 && prescription['controls'].posology['controls'].strength['controls'].calculatortype.value=='null'"
                                                                class="small">
                                                                (Dose will be
                                                                automatically rounded to
                                                                '{{formsettings.roundingfactor}}'
                                                                for this
                                                                medication)</span>
                                                            <span
                                                                *ngIf="formsettings.roundingfactor > 0 && prescription['controls'].posology['controls'].strength['controls'].calculatortype.value!='null'"
                                                                class="small text-warning">
                                                                (Rounding of dose is disabled when using the dose
                                                                calculator)</span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="row" *ngIf="!this.formsettings.dose_type">
                                                    <div class="col">
                                                        <label class="text-danger" #vtmdoseerror>
                                                            {{vtmerrormsg}}
                                                        </label>
                                                    </div>
                                                </div>

                                                <div
                                                    *ngIf="(formsettings.infusionType == 'ci' || formsettings.infusionType == 'pca' || !prescription['controls'].titration.value) && !formsettings.isOxygen">
                                                    <div *ngIf="(formsettings.isInfusion || formsettings.interval_type == 'standard')"
                                                        formGroupName="posology">
                                                        <div formGroupName="strength">
                                                            <div class="row" *ngIf="formsettings.dose_type == 'units'"
                                                                #dose_units>
                                                                <div *ngIf="formsettings.isNeumeratorOnlyStrength"
                                                                    class="col-xs-12">
                                                                    <input type="text" inputmode="numeric"
                                                                        positiveNumberRange
                                                                        (change)="StrengthToUnitDose(null,false,formsettings);RoundPrescribingDose(null,formsettings);StrengthToUnitDose(null,true,formsettings);Calculator_DosePerKgM2('1',null,formsettings);DoseCalculations();FixDecimalPlaces(['posology.strength.dose_size','posology.strength.calculatorinput']);"
                                                                        style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                                        formControlName="totalstrength" enterIsNext
                                                                        [ngClass]="{'form-control':true, 'border-danger':IsDoseValid()}" />
                                                                </div>
                                                                <div *ngIf="formsettings.isNeumeratorOnlyStrength"
                                                                    class="col-xs-12  mr-2"
                                                                    style="margin-top: 0.8em;margin-left: 0.2em;">
                                                                    <label> {{formsettings.singleIngredientStrength}}
                                                                    </label>
                                                                </div>
                                                                <div class="col-xs-12">
                                                                    <input type="text" positiveNumberRange
                                                                        (change)="RoundPrescribingDose(null,formsettings);DoseSizeChanged($event);StrengthToUnitDose(null,true,formsettings);Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['posology.strength.totalstrength','posology.strength.calculatorinput']);"
                                                                        style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                                        formControlName="dose_size" enterIsNext
                                                                        [ngClass]="{'form-control':true, 'border-danger':IsDoseValid()}" />
                                                                </div>
                                                                <div class="col-xs-12"
                                                                    style="margin-top: 0.8em;margin-left: 0.2em;"
                                                                    *ngIf="formsettings.medication.productType.toLowerCase() !='vtm' && !formsettings.vtmstyle">
                                                                    <label>
                                                                        <!-- *ngIf="formsettings.medication.productType.toLowerCase() !='vtm'"> -->
                                                                        {{formsettings.dose_units}}
                                                                    </label>
                                                                </div>
                                                                <div class="col-xs-12" style="margin-left: 0.2em;">
                                                                    <select (change)="VtmUnitsChanged()"
                                                                        formControlName="dose_units"
                                                                        class="form-control"
                                                                        *ngIf="formsettings.medication.productType.toLowerCase() =='vtm' || formsettings.vtmstyle">
                                                                        <option [value]="un"
                                                                            *ngFor="let un of formsettings.vtm_dose_units">
                                                                            {{un}}
                                                                        </option>
                                                                    </select>
                                                                </div>
                                                                <div *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value!='null'"
                                                                    class="col-xs-12 ml-2">
                                                                    <input type="text" inputmode="numeric"
                                                                        positiveNumberRange
                                                                        (change)="Calculator_DosePerKgM2('2',null,formsettings);RoundPrescribingDose(null,formsettings);StrengthToUnitDose(null,true,formsettings);DoseCalculations();FixDecimalPlaces(['posology.strength.totalstrength','posology.strength.dose_size']);"
                                                                        style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                                        formControlName="calculatorinput" enterIsNext
                                                                        [ngClass]="{'form-control':true}" />
                                                                </div>
                                                                <div *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value!='null'"
                                                                    class="col-xs-12"
                                                                    style="margin-top: 0.8em;margin-left: 0.2em;">
                                                                    <label> {{doseunitsdisplaytext}}
                                                                        <span
                                                                            *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'kg'">/kg/dose
                                                                            (<span
                                                                                *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                                                *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                                            Weight)</span>
                                                                        <span
                                                                            *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'ikg'">/kg/dose
                                                                            (Ideal body weight)</span>
                                                                        <span
                                                                            *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'm2'">/m2/dose</span>
                                                                    </label>
                                                                </div>
                                                                <div class="col-xs-12 ml-3">
                                                                    <div class="btn-group dropright">
                                                                        <img [hidden]="!(appService.refWeightValue && formsettings.medication.formularyIngredients)"
                                                                            class="dropdown-toggle Calculatorddl"
                                                                            data-toggle="dropdown" aria-haspopup="true"
                                                                            aria-expanded="false" />


                                                                        <div class="dropdown-menu">

                                                                            <a class="dropdown-item"
                                                                                (click)="SetCalculatorType('kg');Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['posology.strength.calculatorinput']);"
                                                                                href="#">{{doseunitsdisplaytext}}/kg/dose
                                                                                (<span
                                                                                    *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                                                    *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                                                Weight)</a>
                                                                            <a class="dropdown-item"
                                                                                *ngIf="appService.idealWeightValue>0"
                                                                                (click)="SetCalculatorType('ikg');Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['posology.strength.calculatorinput']);"
                                                                                href="#">{{doseunitsdisplaytext}}/kg/dose
                                                                                (Ideal body weight)</a>
                                                                            <a class="dropdown-item"
                                                                                *ngIf="appService.bodySurfaceArea>0"
                                                                                (click)="SetCalculatorType('m2');Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['posology.strength.calculatorinput']);"
                                                                                href="#">{{doseunitsdisplaytext}}/m2/dose</a>
                                                                            <a class="dropdown-item"
                                                                                (click)="SetCalculatorType('null')"
                                                                                href="#">No Calculator</a>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row"
                                                                *ngIf="formsettings.dose_type == 'strength'"
                                                                #dose_strength>
                                                                <div class="col-xs-12">
                                                                    <!-- the order of functions in change handler is important for proper rounding of all doses -->
                                                                    <input type="text" inputmode="numeric"
                                                                        positiveNumbersOnly style="width: 80px;"
                                                                        (change)="CalculateVolumeFordose();RoundPrescribingDose(null,formsettings);CalculateDoseForVolume();Calculator_DosePerKgM2('1',null,formsettings);DoseCalculations();FixDecimalPlaces(['posology.strength.dose_strength_denominator','posology.strength.calculatorinput']);"
                                                                        formControlName="dose_strength_neumerator"
                                                                        enterIsNext
                                                                        [ngClass]="{'form-control':true, 'border-danger':IsDoseValid()}" />
                                                                </div>
                                                                <div class="col-xs-12"
                                                                    style="margin-top: 0.8em;margin-left: 0.2em;">
                                                                    <label>
                                                                        {{formsettings.dose_strength_neumerator_units}}
                                                                    </label>
                                                                </div>
                                                                <div class="col-xs-12" style="margin: 0.3em;">
                                                                    <label style="font-size: 1.5em;"> / </label>
                                                                </div>
                                                                <div class="col-xs-12">
                                                                    <!-- the order of functions in change handler is important for proper rounding of all doses -->
                                                                    <input type="text" inputmode="numeric"
                                                                        positiveNumbersOnly style="width: 80px;"
                                                                        (change)="RoundPrescribingDose(null,formsettings);CalculateDoseForVolume();Calculator_DosePerKgM2('1',null,formsettings);DoseCalculations();FixDecimalPlaces(['posology.strength.dose_strength_neumerator','posology.strength.calculatorinput']);"
                                                                        formControlName="dose_strength_denominator"
                                                                        enterIsNext
                                                                        [ngClass]="{'form-control':true, 'border-danger':IsDoseValid()}" />
                                                                </div>
                                                                <div class="col-xs-12"
                                                                    style="margin-top: 0.8em;margin-left: 0.2em;">

                                                                    <label>
                                                                        {{formsettings.dose_strength_denominator_units}}
                                                                    </label>
                                                                </div>
                                                                <div *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value!='null'"
                                                                    class="col-xs-12 ml-2">
                                                                    <!-- the order of functions in change handler is important for proper rounding of all doses -->
                                                                    <input type="text" inputmode="numeric"
                                                                        positiveNumbersOnly
                                                                        (change)="Calculator_DosePerKgM2('2',null,formsettings);CalculateVolumeFordose();RoundPrescribingDose(null,formsettings);CalculateDoseForVolume(); DoseCalculations();FixDecimalPlaces(['posology.strength.dose_strength_neumerator','posology.strength.dose_strength_denominator']);"
                                                                        style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                                        formControlName="calculatorinput" enterIsNext
                                                                        [ngClass]="{'form-control':true}" />
                                                                </div>
                                                                <div *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value!='null'"
                                                                    class="col-xs-12"
                                                                    style="margin-top: 0.8em;margin-left: 0.2em;">
                                                                    <label> {{doseunitsdisplaytext}}
                                                                        <span
                                                                            *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'kg'">/kg/dose
                                                                            (<span
                                                                                *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                                                *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                                            Weight)</span>
                                                                        <span
                                                                            *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'ikg'">/kg/dose
                                                                            (Ideal body weight)</span>
                                                                        <span
                                                                            *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'm2'">/m2/dose</span>

                                                                    </label>
                                                                </div>
                                                                <div class="col-xs-12 ml-3">
                                                                    <div class="btn-group dropright">
                                                                        <img [hidden]="!(appService.refWeightValue && formsettings.medication.formularyIngredients)"
                                                                            class="dropdown-toggle Calculatorddl"
                                                                            data-toggle="dropdown" aria-haspopup="true"
                                                                            aria-expanded="false" />


                                                                        <div class="dropdown-menu">
                                                                            <a class="dropdown-item"
                                                                                (click)="SetCalculatorType('kg');Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['posology.strength.calculatorinput']);"
                                                                                href="#">{{doseunitsdisplaytext}}/kg/dose
                                                                                (<span
                                                                                    *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                                                    *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                                                Weight)</a>
                                                                            <a class="dropdown-item"
                                                                                *ngIf="appService.idealWeightValue>0"
                                                                                (click)="SetCalculatorType('ikg');Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['posology.strength.calculatorinput']);"
                                                                                href="#">{{doseunitsdisplaytext}}/kg/dose
                                                                                (Ideal body weight)</a>
                                                                            <a class="dropdown-item"
                                                                                *ngIf="appService.bodySurfaceArea>0"
                                                                                (click)="SetCalculatorType('m2');Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['posology.strength.calculatorinput']);"
                                                                                href="#">{{doseunitsdisplaytext}}/m2/dose</a>
                                                                            <a class="dropdown-item"
                                                                                (click)="SetCalculatorType('null')"
                                                                                href="#">No Calculator</a>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row"
                                                                *ngIf="formsettings.dose_type == 'descriptive'"
                                                                #dose_descriptive>
                                                                <div class="col-xs-12" style="width: 95%;">
                                                                    <input placeholder="Instructions for taking"
                                                                        style="height: 30px; font-size: 80%; width:30em;"
                                                                        formControlName="dose_description" enterIsNext
                                                                        [ngClass]="{'form-control':true, 'border-danger':IsDoseValid()}" />
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div
                                                    *ngIf="formsettings.medication.detail.titrationTypes && formsettings.medication.detail.titrationTypes.length>0">
                                                    <label>
                                                        <input (change)="TitrationToggled()" type="checkbox"
                                                            formControlName="titration" />
                                                        Titrate on
                                                        {{formsettings.medication.detail.titrationTypes[0].desc}}
                                                    </label>


                                                    <div class="mt-n3" *ngIf="prescription['controls'].titration.value">
                                                        <div class="row">
                                                            <div class="col headerlabeldiv">
                                                                <label>
                                                                    <span>Target
                                                                        {{formsettings.medication.detail.titrationTypes[0].desc}}
                                                                    </span>
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <!-- controls for oxygen saturation percentage selection -->
                                                        <div class="mt-2 mb-1"
                                                            *ngIf="titrationvalues && titrationvalues.length>0">
                                                            <span (click)="SetTitrationValue(v)"
                                                                *ngFor="let v of titrationvalues"
                                                                class="mr-1 btn btn-sm alert-info border">{{v}} <span
                                                                    *ngIf="formsettings.titrationUnits">
                                                                    {{formsettings.titrationUnits}}
                                                                </span></span>
                                                        </div>
                                                        <input
                                                            [ngClass]="{'mt-2':true, 'border-danger':IsTitrationTargetMinValid()}"
                                                            type="number"
                                                            [placeholder]="prescription['controls'].istitrationrange.value? 'Min':''"
                                                            style="width: 60px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                            inputmode="numeric" positiveNumbersOnly
                                                            formControlName="titrationtargetmin" enterIsNext />
                                                        <label *ngIf="formsettings.titrationUnits"
                                                            class="p-1 btn-sm font-weight-bold">
                                                            {{formsettings.titrationUnits}}
                                                        </label>
                                                        <input placeholder="Max"
                                                            [ngClass]="{'ml-1':true, 'border-danger':IsTitrationTargetMaxValid()}"
                                                            type="number"
                                                            *ngIf="prescription['controls'].istitrationrange.value"
                                                            style="width: 60px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                            inputmode="numeric" positiveNumbersOnly
                                                            formControlName="titrationtargetmax" enterIsNext />
                                                        <label
                                                            *ngIf="formsettings.titrationUnits && prescription['controls'].istitrationrange.value"
                                                            class="p-1 btn-sm font-weight-bold">
                                                            {{formsettings.titrationUnits}}
                                                        </label>
                                                        <label class="ml-2">
                                                            <input type="checkbox" formControlName="istitrationrange" />
                                                            Specify Range
                                                        </label>

                                                    </div>


                                                </div>
                                                <div
                                                    *ngIf="!formsettings.isInfusion && formsettings.interval_type == 'variable'">
                                                    <div *ngFor="let ts of formsettings.dosing_pattern" class="row">
                                                        <div class="col-xs-12  small text-muted">
                                                            <span>{{ts.GetFormatString()}}</span>
                                                        </div>
                                                        <div class="col-xs-12  small text-muted">
                                                            <span> - </span>
                                                        </div>
                                                        <div class="col-xs-12  small ml-2">
                                                            <span>{{ts.GetDoseFormatString(formsettings)}}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row mb-n2"
                                                    *ngIf="((formsettings.medication.productType.toLowerCase() =='vtm' || formsettings.vtmstyle) && formsettings.diluents.length==0 && !prescription['controls'].titration.value)  || (this.formsettings.dose_type && !IsIVRoute() &&  !formsettings.isOxygen && formsettings.dose_type!='descriptive' && !prescription['controls'].posology['controls'].interval['controls'].prn.value && !prescription['controls'].titration.value)">
                                                    <div class="col-xs-12">
                                                        <a class="h6" href="#" (click)="OpenVariableForm()">
                                                            Variable
                                                        </a>
                                                        <a *ngIf="formsettings.interval_type != 'standard'" href="#"
                                                            class="h6" (click)="ClearVariable()">
                                                            Clear Variable</a>
                                                    </div>
                                                </div>
                                                <div *ngIf="formsettings.isOxygen" class="row">
                                                    <div class="col-xs-12 headerlabeldiv  text-muted">
                                                        <label>
                                                            <span>Device</span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="row mt-2" *ngIf="formsettings.isOxygen">
                                                    <select formControlName="oxygendevice" class="form-control">
                                                        <option value="null">
                                                            Select Device
                                                        </option>
                                                        <option [value]="od.code"
                                                            *ngFor="let od of appService.oxygenDevices">
                                                            {{od.name}}
                                                        </option>
                                                    </select>
                                                </div>
                                                <div *ngIf="formsettings.isOxygen" class="row">
                                                    <div class="col-xs-12 headerlabeldiv  text-muted">
                                                        <label>
                                                            <span>Additional Information</span>
                                                        </label>
                                                    </div>
                                                </div>

                                                <div class="row mt-2" *ngIf="formsettings.isOxygen">
                                                    <label
                                                        *ngFor="let info of formsettings.oxygenprescriptionadditionalinfo">
                                                        <input type="checkbox" [checked]="info.isChecked"
                                                            (change)="OxygenAdditionalInfoChanged($event,info)"
                                                            [id]="info.oxygenprescriptionadditionalinfo_id"
                                                            [value]="info.oxygenprescriptionadditionalinfo_id"
                                                            #o2addlinfo>
                                                        <span>{{info.additionalinfo}}</span>
                                                    </label>
                                                </div>
                                            </td>
                                            <td class="float-right">
                                                <div class="row justifytoend">
                                                    <div class="criticaldrug_image p-3"
                                                        (click)="ShowHideMedicationFlagMessage('critical')"
                                                        *ngIf="formsettings.MedicationHasFlag('critical')">
                                                    </div>
                                                    <div class="controlleddrug_image p-3"
                                                        (click)="ShowHideMedicationFlagMessage('controlled')"
                                                        *ngIf="formsettings.MedicationHasFlag('controlled')">
                                                    </div>
                                                    <div class="highalertdrug_image p-3"
                                                        (click)="ShowHideMedicationFlagMessage('highalert')"
                                                        *ngIf="formsettings.MedicationHasFlag('highalert')">
                                                    </div>
                                                    <div class="unlicenceddrug_image p-3"
                                                        (click)="ShowHideMedicationFlagMessage('unlicenced')"
                                                        *ngIf="formsettings.MedicationHasFlag('unlicenced')">
                                                    </div>
                                                    <div class="blacktriangledrug_image p-3"
                                                        (click)="ShowHideMedicationFlagMessage('blacktriangle')"
                                                        *ngIf="formsettings.MedicationHasFlag('blacktriangle')">
                                                    </div>
                                                    <div class="nonformularydrug_image p-3"
                                                        (click)="ShowHideMedicationFlagMessage('nonformulary')"
                                                        *ngIf="formsettings.MedicationHasFlag('nonformulary')">
                                                    </div>
                                                    <div class="expensiverug_image p-3"
                                                        (click)="ShowHideMedicationFlagMessage('expensive')"
                                                        *ngIf="formsettings.MedicationHasFlag('expensive')">
                                                    </div>
                                                    <div class="clinicaltrialdrug_image p-3"
                                                        (click)="ShowHideMedicationFlagMessage('clinicaltrial')"
                                                        *ngIf="formsettings.MedicationHasFlag('clinicaltrial')">
                                                    </div>
                                                    <div class="bloodproduct_image p-3"
                                                        (click)="ShowHideMedicationFlagMessage('bloodproduct')"
                                                        *ngIf="formsettings.MedicationHasFlag('bloodproduct')">
                                                    </div>
                                                    <div style="display: flex;float:right;">
                                                        <button
                                                            *ngIf="formsettings.nursinginstructions && formsettings.nursinginstructions.length >0"
                                                            (click)="showNursingInstructions()" type="button"
                                                            class='{{"btn-flat btn-menu pharmacist-property-icon Nursing_Instruction"}}'></button>
                                                    </div>
                                                </div>
                                                <div [@showhide]="showmedicationflag ? 'shown' : 'closed'" class="row">
                                                    <span class="alert-info small rounded">{{ medicationgflagmessage }}
                                                    </span>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>

                                <!-- PRN DO row  -->


                                <div class="mt-3">
                                    <div formGroupName="posology">
                                        <div formGroupName="interval">
                                            <div class="row" #prndo>
                                                <div class="col-xs-12"
                                                    *ngIf="!this.formsettings.isInfusion && this.formsettings.interval_type !='variable'  && this.formsettings.interval_type !='protocol' 
                                                && prescription['controls'].titration.value != true && this.formsettings.notforprn == false">
                                                    <div class="ck-button">
                                                        <label>
                                                            <input formControlName="prn" type="checkbox" id="prn"
                                                                value="prn">
                                                            <span>PRN</span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-xs-12"
                                                    *ngIf="!this.formsettings.isInfusion && showDoctorsOrder && prescription['controls'].titration.value != true">
                                                    <div class="ck-button">
                                                        <label>
                                                            <input formControlName="do" type="checkbox" id="do"
                                                                value="do">
                                                            <span>PTC</span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col" style="margin-top: -0.96em;"
                                                    *ngIf="prescription['controls'].posology['controls'].interval['controls'].prn.value">
                                                    <div *ngIf="(formsettings.dose_type == 'units' && formsettings.isNeumeratorOnlyStrength) || formsettings.dose_type == 'strength'"
                                                        class="small text-muted">
                                                        Maximum dose in 24 hours
                                                    </div>
                                                    <div *ngIf="formsettings.dose_type == 'units' && !formsettings.isNeumeratorOnlyStrength && formsettings.dose_units.toLowerCase() != 'ml' && this.formsettings.dose_units.toLowerCase() != 'litre'"
                                                        class="small text-muted">
                                                        Maximum number of {{formsettings.dose_units}}(s) that should be
                                                        given in 24 hours
                                                    </div>
                                                    <div *ngIf="formsettings.dose_type == 'units' && !formsettings.isNeumeratorOnlyStrength && (formsettings.dose_units.toLowerCase() == 'ml' || this.formsettings.dose_units.toLowerCase() == 'litre')"
                                                        class="small text-muted">
                                                        Maximum Dose in 24 hours in {{formsettings.dose_units}}(s)
                                                    </div>
                                                    <div *ngIf="formsettings.dose_type == 'descriptive'"
                                                        class="small text-muted">
                                                        Maximum number of doses that should be given in 24 hours
                                                    </div>
                                                    <div>
                                                        <div style="padding-left: 1em;" class="row"
                                                            *ngIf="formsettings.dose_type == 'units'"
                                                            #prn_max_dose_units>
                                                            <div *ngIf="formsettings.isNeumeratorOnlyStrength"
                                                                class="col-xs-12">
                                                                <input type="text" inputmode="numeric"
                                                                    positiveNumberRange
                                                                    (input)="formsettings.prnMaxDose_TimeSlot.dose_totalstrength = $event.target.value"
                                                                    (change)="StrengthToUnitDose(formsettings.prnMaxDose_TimeSlot,false,formsettings);RoundPrescribingDose(formsettings.prnMaxDose_TimeSlot,formsettings);StrengthToUnitDose(formsettings.prnMaxDose_TimeSlot,true,formsettings);ValidatePrnMaxDose();"
                                                                    style="height: 74%;width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                                    [value]="formsettings.prnMaxDose_TimeSlot.dose_totalstrength ? formsettings.prnMaxDose_TimeSlot.dose_totalstrength : ''"
                                                                    enterIsNext
                                                                    [ngClass]="{'form-control':true, 'border-danger':!isPrnMaxDoseValid}" />
                                                            </div>
                                                            <div *ngIf="formsettings.isNeumeratorOnlyStrength"
                                                                class="col-xs-12  mr-2"
                                                                style="margin-top: 0.4em;margin-left: 0.2em;">
                                                                <label> {{formsettings.singleIngredientStrength}}
                                                                </label>
                                                            </div>
                                                            <div class="col-xs-12">
                                                                <input type="text" positiveNumberRange
                                                                    (input)="formsettings.prnMaxDose_TimeSlot.dose_size = $event.target.value"
                                                                    (change)="RoundPrescribingDose(formsettings.prnMaxDose_TimeSlot,formsettings);StrengthToUnitDose(formsettings.prnMaxDose_TimeSlot,true,formsettings);ValidatePrnMaxDose();"
                                                                    style="height: 74%;width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                                    [value]="GetVariableDoseSizeInputText(formsettings.prnMaxDose_TimeSlot)"
                                                                    enterIsNext
                                                                    [ngClass]="{'form-control':true, 'border-danger':!isPrnMaxDoseValid}" />
                                                            </div>
                                                            <div class="col-xs-12"
                                                                style="margin-top: 0.4em;margin-left: 0.2em;">
                                                                <label>
                                                                    <!-- *ngIf="formsettings.medication.productType.toLowerCase() !='vtm'"> -->
                                                                    {{formsettings.dose_units}}
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div style="padding-left: 1em;" class="row"
                                                            *ngIf="formsettings.dose_type == 'strength'"
                                                            #prn_max_dose_strength>
                                                            <div class="col-xs-12">
                                                                <input type="text" positiveNumbersOnly
                                                                    inputmode="numeric"
                                                                    style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                                    [value]="GetVariableDoseSNInputText(formsettings.prnMaxDose_TimeSlot)"
                                                                    [ngClass]="{'form-control':true, 'border-danger':!isPrnMaxDoseValid}"
                                                                    (input)="formsettings.prnMaxDose_TimeSlot.dose_strength_neumerator = $event.target.value;"
                                                                    (change)="CalculateTSVolumeFordose(formsettings.prnMaxDose_TimeSlot,formsettings);RoundPrescribingDose(formsettings.prnMaxDose_TimeSlot,formsettings);CalculateTSDoseForVolume(formsettings.prnMaxDose_TimeSlot,formsettings);ValidatePrnMaxDose();" />
                                                            </div>
                                                            <div class="col-xs-12  mr-2"
                                                                style="margin-top: 0.4em;margin-left: 0.2em;">
                                                                <label>
                                                                    {{formsettings.dose_strength_neumerator_units}}
                                                                </label>
                                                            </div>
                                                            <div class="col-xs-12">
                                                                <input type="text" positiveNumbersOnly
                                                                    inputmode="numeric"
                                                                    style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                                    [ngClass]="{'form-control':true, 'border-danger':!isPrnMaxDoseValid}"
                                                                    (input)="formsettings.prnMaxDose_TimeSlot.dose_strength_denominator = $event.target.value;"
                                                                    (change)="RoundPrescribingDose(formsettings.prnMaxDose_TimeSlot,formsettings);CalculateTSDoseForVolume(formsettings.prnMaxDose_TimeSlot,formsettings);ValidatePrnMaxDose();"
                                                                    [value]="GetVariableDoseSDInputText(formsettings.prnMaxDose_TimeSlot)" />
                                                            </div>
                                                            <div class="col-xs-12"
                                                                style="margin-top: 0.4em;margin-left: 0.2em;">
                                                                <label>
                                                                    {{formsettings.dose_strength_denominator_units}}
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div style="padding-left: 1em;" class="row"
                                                            *ngIf="formsettings.dose_type == 'descriptive'"
                                                            #prn_max_dose_descriptive>
                                                            <div class="col-xs-12">
                                                                <input
                                                                    style="height: 74%; width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                                    (input)="formsettings.prnMaxDose_TimeSlot.dose_description = $event.target.value;"
                                                                    [value]="GetVariableDoseDescInputText(formsettings.prnMaxDose_TimeSlot)"
                                                                    [ngClass]="{'form-control':true, 'border-danger':!isPrnMaxDoseValid}"
                                                                    (change)="ValidatePrnMaxDose();" enterIsNext
                                                                    type="text" positiveNumbersOnly />
                                                            </div>
                                                            <div class="col-xs-12"
                                                                style="margin-top: 0.4em;margin-left: 0.2em;">
                                                                <label>
                                                                    doses
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-12"
                                        *ngIf="formsettings.medication.productType.toLowerCase() =='vtm'">
                                        <div class="ml-3 row">
                                            <div class="col-xs-12 ck-button"
                                                *ngIf="formsettings.medication.detail.isModifiedRelease">
                                                <label>
                                                    <input formControlName="ismodifiedrelease" type="checkbox"
                                                        id="ismodifiedrelease" value="ismodifiedrelease">
                                                    <span>MR</span>
                                                </label>
                                            </div>
                                            <div class="col-xs-12 ck-button"
                                                *ngIf="formsettings.medication.detail.isGastroResistant">
                                                <label>
                                                    <input formControlName="isgastroresistant" type="checkbox"
                                                        id="isgastroresistant" value="isgastroresistant">
                                                    <span>GR</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- name and info row  -->
                                <div *ngIf="formsettings.diluents.length>0" class="row headerlabeldiv  text-muted">
                                    <label>
                                        <span>Diluent</span>
                                    </label>
                                </div>
                                <div *ngFor="let d of formsettings.diluents">
                                    <div class="row">
                                        <div class="col-xs-12" style="width: 90%;">
                                            <label for="txt_dname" hidden>Medication name:</label>
                                            <input style="height: 30px; font-size: 85%;" [value]="d.fs.medication.name"
                                                enterIsNext class="form-control" id="txt_dname" readonly />
                                        </div>
                                        <div class="col-xs-12 p-3 druginfo_image" (click)="showDrugInfo(d)">

                                        </div>
                                    </div>
                                    <div>
                                        <table style="width: 90%;">
                                            <tr>
                                                <td class="float-left">
                                                    <!-- dose row  -->
                                                    <!-- <div class="row">
                                                        <div class="col-xs-12 headerlabeldiv  text-muted">
                                                            <label>
                                                                <span>Dose</span>
                                                            </label>
                                                        </div>
                                                    </div> -->
                                                    <div formGroupName="posology">
                                                        <div formGroupName="strength"
                                                            [ngClass]="{'row':true, 'border rounded border-danger':!isdiluentdosevalid}">
                                                            <ng-template [ngTemplateOutlet]="dosetemplate"
                                                                [ngTemplateOutletContext]="{ts:d.ts, fs:d.fs,context:'diluent'}">
                                                            </ng-template>

                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="float-right">
                                                    <div class="row justifytoend">
                                                        <a href="#" class="mt-2" class="h6"
                                                            (click)="RemoveDiluent(d)">Remove</a>
                                                        <div class="criticaldrug_image p-3"
                                                            (click)="ShowHideMedicationFlagMessage('critical',d)"
                                                            *ngIf="formsettings.MedicationHasFlag('critical',d.fs.medication)">
                                                        </div>
                                                        <div class="controlleddrug_image p-3"
                                                            (click)="ShowHideMedicationFlagMessage('controlled',d)"
                                                            *ngIf="formsettings.MedicationHasFlag('controlled',d.fs.medication)">
                                                        </div>
                                                        <div class="highalertdrug_image p-3"
                                                            (click)="ShowHideMedicationFlagMessage('highalert',d)"
                                                            *ngIf="formsettings.MedicationHasFlag('highalert',d.fs.medication)">
                                                        </div>
                                                        <div class="unlicenceddrug_image p-3"
                                                            (click)="ShowHideMedicationFlagMessage('unlicenced',d)"
                                                            *ngIf="formsettings.MedicationHasFlag('unlicenced',d.fs.medication)">
                                                        </div>
                                                        <div class="blacktriangledrug_image p-3"
                                                            (click)="ShowHideMedicationFlagMessage('blacktriangle',d)"
                                                            *ngIf="formsettings.MedicationHasFlag('blacktriangle',d.fs.medication)">
                                                        </div>
                                                        <div class="nonformularydrug_image p-3"
                                                            (click)="ShowHideMedicationFlagMessage('nonformulary',d)"
                                                            *ngIf="formsettings.MedicationHasFlag('nonformulary',d.fs.medication)">
                                                        </div>
                                                        <div class="expensiverug_image p-3"
                                                            (click)="ShowHideMedicationFlagMessage('expensive',d)"
                                                            *ngIf="formsettings.MedicationHasFlag('expensive',d.fs.medication)">
                                                        </div>
                                                        <div class="clinicaltrialdrug_image p-3"
                                                            (click)="ShowHideMedicationFlagMessage('clinicaltrial',d)"
                                                            *ngIf="formsettings.MedicationHasFlag('clinicaltrial',d.fs.medication)">
                                                        </div>
                                                        <div class="bloodproduct_image p-3"
                                                            (click)="ShowHideMedicationFlagMessage('bloodproduct',d)"
                                                            *ngIf="formsettings.MedicationHasFlag('bloodproduct',d.fs.medication)">
                                                        </div>
                                                    </div>
                                                    <div [@showhide]="d.showmedicationflag ? 'shown' : 'closed'"
                                                        class="row">
                                                        <span class="alert-info small rounded">{{ medicationgflagmessage
                                                            }}
                                                        </span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="mt-3 ml-n3 col">
                                        <a href="#"
                                            *ngIf="(IsIVRoute() && formsettings.diluents.length == 0 && formsettings.interval_type=='standard')"
                                            class="h6" (click)="AddDiluent()">
                                            Add Diluent </a>
                                    </div>
                                    <div class="float-right mr-4"
                                        *ngIf="(formsettings.diluents.length >0 || (formsettings.vtmstyle && formsettings.medication.productType.toLowerCase() !='vtm') || this.formsettings.isInfusion) && GetDoseSolutionQuantity() >0">
                                        <div class="col-xs-12 headerlabeldiv">
                                            Total volume :
                                            {{ totalvolumedisplay }} ml <br>
                                            <span *ngIf="prescribedConcentration">Concentration:
                                                {{prescribedConcentration}}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-1 p-2 border rounded " *ngIf="showSearchMedication">
                                    <!-- <app-search-medication (medicationselected)="OnDiluentSelected($event)">
                                            </app-search-medication> -->
                                    <!-- <select (change)="ToggleDiluentList()" class="form-control mt-1" id="ddldiluents"
                                        #ddldiluents>
                                        <option [value]="dl.code" *ngFor="let dl of allDiluents">
                                            {{dl.name}}</option>
                                    </select> -->
                                    <!-- <label class="text-danger ml-1">{{lblerrordiluent}}</label> -->
                                    <!-- <a href="#" (click)="OnDiluentSelected()" class="h6"
                                        class="float-right btn-sm btn-link">Add</a>
                                    <a href="#" (click)="CloseDiluentSearch()" class="h6"
                                        class="float-right btn-sm btn-link">Cancel</a> -->

                                    <div class="btn-group" dropdown [isOpen]="true" [autoClose]="false">
                                        <button dropdownToggle type="button"
                                            class="btn btn-sm btn-primary dropdown-toggle">
                                            Select Diluent <span class="caret"></span>
                                        </button>
                                        <a href="#" (click)="CloseDiluentSearch()" class="h6"
                                            class="float-right btn-sm btn-link">Cancel</a>
                                        <a (click)="ToggleDiluentList()"
                                            *ngIf="allDiluents.length!=0 && showCompatibleDiluents"
                                            class="btn-sm btn-link" href="#">Show
                                            Compatible Diluents</a>
                                        <a (click)="ToggleDiluentList()"
                                            *ngIf="allDiluents.length!=0 && !showCompatibleDiluents"
                                            class="btn-sm btn-link" href="#">Show
                                            All Diluents</a>
                                        <ul *dropdownMenu class="dropdown-menu p-2 customdropdownul" role="menu">
                                            <li role="menuitem"
                                                *ngIf="allDiluents?.length==0 && !showCompatibleDiluents" class="p-2">
                                                There are no
                                                compatible diluents</li>
                                            <li role="menuitem" *ngIf="allDiluents?.length==0 && showCompatibleDiluents"
                                                class="p-2">
                                                There are no diluents</li>
                                            <li role="menuitem" class="p-2 border-bottom"
                                                (click)="OnDiluentSelected(dl.code)" *ngFor="let dl of allDiluents">
                                                {{dl.name}}
                                            </li>
                                            <li role="menuitem">
                                                <a (click)="ToggleDiluentList()" *ngIf="showCompatibleDiluents"
                                                    class="dropdown-item text-info" href="#">Show
                                                    Compatible Diluents</a>
                                                <a (click)="ToggleDiluentList()" *ngIf="!showCompatibleDiluents"
                                                    class="dropdown-item text-info" href="#">Show
                                                    All Diluents</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>


                                <!-- route row was here -->
                                <div class="row m-1 alert-danger rounded" [hidden]="ShowEnterDoseMessage() == false">
                                    <span *ngIf="formsettings.isPrimaryMedicationUOMLiquid">
                                        Please enter a dose
                                    </span>
                                    <span *ngIf="!formsettings.isPrimaryMedicationUOMLiquid">
                                        Please add a diluent
                                    </span>
                                </div>


                                <div class="mt-2" [hidden]="ShowInfusionControls() == false" #infusionrate>
                                    <div
                                        *ngIf="formsettings.isInfusion && formsettings.infusionType == 'rate' && formsettings.interval_type=='variable' && GetVariableInfusionTotalPrescribedVolume(true).toString().startsWith('invalid')">
                                        <div class="small text-danger">
                                            Total infusion volume does not match the prescribed volume in variable
                                            infusion
                                            pattern.
                                        </div>
                                    </div>
                                    <div class="row" [hidden]="formsettings.interval_type=='variable'">
                                        <div class="col-xs-12">
                                            <div class="headerlabeldiv  text-muted">
                                                <label>
                                                    <span *ngIf="prescription['controls'].titration.value">Initial
                                                        Rate</span>
                                                    <span *ngIf="!prescription['controls'].titration.value">Rate</span>
                                                </label>
                                            </div>
                                            <input type="number"
                                                style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                inputmode="numeric" positiveNumbersOnly
                                                (change)="InfusionRateChanged();RateToDoseRate();Calculator_DoseRatePerKgM2('1',null, formsettings); FixDecimalPlaces(['infusiondoserate','posology.strength.calculatorinput_doserate','infusionduration']);"
                                                formControlName="infusionrate" enterIsNext
                                                [ngClass]="{'form-control':true, 'border-danger':IsInfusionRateValid()}" />
                                        </div>
                                        <div class="col-xs-12" style="margin-top: 0.8em;margin-left: 0.2em;">
                                            <div class="headerlabeldiv  text-muted">
                                                <label>
                                                    <span>&nbsp;</span>
                                                </label>
                                            </div>
                                            <label> {{formsettings.infusionrateunits}} </label>
                                        </div>
                                        <!-- infusion dose rate -->
                                        <div class="col-xs-12 ml-1" *ngIf="infusionDoseRateUnits!='/hr'">
                                            <div class="headerlabeldiv  text-muted">
                                                <label>
                                                    <span>Dose Rate</span>
                                                </label>
                                            </div>
                                            <input type="number"
                                                style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                inputmode="numeric" positiveNumbersOnly
                                                (change)="RateToDoseRate(true);Calculator_DoseRatePerKgM2('1',null, formsettings);InfusionRateChanged();FixDecimalPlaces(['infusionrate','posology.strength.calculatorinput_doserate','infusionduration']);"
                                                formControlName="infusiondoserate" enterIsNext
                                                [ngClass]="{'form-control':true, 'border-danger':IsInfusionRateValid()}" />
                                        </div>
                                        <div class="col-xs-12" style="margin-top: 0.8em;margin-left: 0.2em;"
                                            *ngIf="infusionDoseRateUnits!='/hr'">
                                            <div class="headerlabeldiv  text-muted">
                                                <label>
                                                    <span>&nbsp;</span>
                                                </label>
                                            </div>
                                            <label> {{infusionDoseRateUnits}} </label>
                                        </div>

                                        <div class="col-xs-12" formGroupName='posology'
                                            *ngIf="infusionDoseRateUnits!='/hr'">
                                            <div class="headerlabeldiv  text-muted">
                                                <label>
                                                    <span>&nbsp;</span>
                                                </label>
                                            </div>
                                            <div formGroupName='strength'
                                                *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype_doserate.value!='null'"
                                                class="col-xs-12 ml-1">
                                                <input type="number" inputmode="numeric" positiveNumbersOnly
                                                    (change)="Calculator_DoseRatePerKgM2('2',null,formsettings);RateToDoseRate(true);InfusionRateChanged();FixDecimalPlaces(['infusiondoserate','infusionrate','infusionduration']);"
                                                    formControlName="calculatorinput_doserate"
                                                    style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                    enterIsNext [ngClass]="{'form-control':true}" />
                                            </div>

                                        </div>
                                        <div *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype_doserate.value!='null'"
                                            class="col-xs-12" style="margin-top: 0.8em;margin-left: 0.2em;">
                                            <div class="headerlabeldiv  text-muted">
                                                <label>
                                                    <span>&nbsp;</span>
                                                </label>
                                            </div>
                                            <label> {{doseunitsdisplaytext}}
                                                <span class="ml-n1"
                                                    *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype_doserate.value == 'kg'">/kg/hr
                                                    (<span
                                                        *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                        *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                    Weight)</span>
                                                <span class="ml-n1"
                                                    *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype_doserate.value == 'ikg'">/kg/hr
                                                    (Ideal body weight)</span>
                                                <span class="ml-n1"
                                                    *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype_doserate.value == 'm2'">/m2/hr</span>
                                            </label>
                                        </div>
                                        <!-- calculator for doserate main form-->
                                        <div class="col-xs-12" *ngIf="infusionDoseRateUnits!='/hr'">
                                            <div class="headerlabeldiv  text-muted">
                                                <label>
                                                    <span>&nbsp;</span>
                                                </label>
                                            </div>
                                            <div class="btn-group dropright">
                                                <img [hidden]="!(appService.refWeightValue && formsettings.medication.formularyIngredients)"
                                                    class="dropdown-toggle Calculatorddl" data-toggle="dropdown"
                                                    aria-haspopup="true" aria-expanded="false" />
                                                <div class="dropdown-menu">
                                                    <a class="dropdown-item"
                                                        (click)="SetCalculatorType_doserate('kg');Calculator_DoseRatePerKgM2('1', null, formsettings);FixDecimalPlaces(['posology.strength.calculatorinput_doserate']);"
                                                        href="#">{{doseunitsdisplaytext}}/kg/hr (<span
                                                            *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                            *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                        Weight)</a>
                                                    <a class="dropdown-item" *ngIf="appService.idealWeightValue>0"
                                                        (click)="SetCalculatorType_doserate('ikg');Calculator_DoseRatePerKgM2('1', null, formsettings);FixDecimalPlaces(['posology.strength.calculatorinput_doserate']);"
                                                        href="#">{{doseunitsdisplaytext}}/kg/hr
                                                        (Ideal body weight)</a>
                                                    <a class="dropdown-item" *ngIf="appService.bodySurfaceArea>0"
                                                        (click)="SetCalculatorType_doserate('m2');Calculator_DoseRatePerKgM2('1', null, formsettings);FixDecimalPlaces(['posology.strength.calculatorinput_doserate']);"
                                                        href="#">{{doseunitsdisplaytext}}/m2/hr</a>
                                                    <a class="dropdown-item"
                                                        (click)="SetCalculatorType_doserate('null');Calculator_DoseRatePerKgM2('1', null, formsettings);"
                                                        href="#">No
                                                        Calculator</a>
                                                </div>
                                            </div>

                                        </div>


                                        <div class="col-xs-12  ml-2" [hidden]="formsettings.infusionType != 'rate'">
                                            <div class="headerlabeldiv  text-muted">
                                                <label>
                                                    <span>Duration</span>
                                                </label>
                                            </div>
                                            <input
                                                (change)="DurationChanged();RateToDoseRate();Calculator_DoseRatePerKgM2('1',null, formsettings)"
                                                type="number" inputmode="numeric" positiveNumbersOnly
                                                style="width: 60px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                formControlName="infusionduration" enterIsNext
                                                [ngClass]="{'form-control':true, 'border-danger':IsInfusionDurationValid()}" />
                                        </div>
                                        <div class="col-xs-12" [hidden]="formsettings.infusionType != 'rate'"
                                            style="margin-top: 0.8em;margin-left: 0.2em;">
                                            <div class="headerlabeldiv  text-muted">
                                                <label>
                                                    <span>&nbsp;</span>
                                                </label>
                                            </div>
                                            <label> hrs </label>
                                        </div>
                                        <div class="col">
                                            <div
                                                *ngIf="prescription['controls'].infusionduration.invalid && (prescription['controls'].infusionduration.dirty || prescription['controls'].infusionduration.touched)">
                                                <div class="small text-danger"
                                                    *ngIf="prescription['controls'].infusionduration.errors.invalid_tssize">
                                                    Duration is too long to fit into the selected dosage intervals
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="row" [hidden]="formsettings.interval_type=='standard'">
                                        <table>
                                            <tr *ngFor="let row of formsettings.infusion_rate_pattern">
                                                <td class="small">
                                                    <span
                                                        *ngIf="ShowInfusionAdjustmentDate() && formContext != 'moa' ">{{
                                                        row.starttime.date |
                                                        date:'dd LLL, '
                                                        }}
                                                    </span>
                                                    {{row.starttime.GetFormatString()}}
                                                </td>
                                                <td class="text-muted small">
                                                    until
                                                </td>
                                                <td class="small">
                                                    <span
                                                        *ngIf="ShowInfusionAdjustmentDate() && formContext != 'moa'">{{row.endtime.date
                                                        |
                                                        date:'dd
                                                        LLL, ' }}
                                                    </span>
                                                    {{row.endtime.GetFormatString()}}
                                                </td>
                                                <td class="text-muted font-weight-bold">
                                                    {{ row.starttime.infusionrate }} {{formsettings.infusionrateunits}}
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="row">
                                        <div class="col-xs-12">
                                            <a class="h6" href="#" (click)="OpenVariableInfusionForm()">
                                                Variable Rate
                                            </a>
                                            <a class="h6" *ngIf="formsettings.interval_type != 'standard'" href="#"
                                                (click)="ClearVariable()">
                                                Clear Variable</a>
                                        </div>
                                    </div>
                                </div>
                                <div *ngIf="!formsettings.isInfusion || (formsettings.infusionType !='ci' && formsettings.infusionType != 'pca')"
                                    formGroupName="posology" #frequencydiv>
                                    <div formGroupName="interval">
                                        <div class="row">
                                            <div class="col-xs-12 headerlabeldiv  text-muted">
                                                <label>
                                                    <span>Dosage Interval</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div *ngIf="formsettings.interval_type == 'standard'" class="row">
                                            <div
                                                [ngClass]="{'col-xs-12':true, 'border rounded border-danger':IsIntervalValid()}">
                                                <!-- <div
                                            *ngIf="!prescription['controls'].posology['controls'].interval['controls'].prn.value"> -->
                                                <div *ngIf="!prescription['controls'].posology['controls'].interval['controls'].prn.value"
                                                    class="col-xs-12 ck-button">
                                                    <label
                                                        *ngIf="!(editingPrescription && !clonePrescription && formContext == 'ip' && appService.GetCurrentPosology(editingPrescription).frequency !== 'stat')">
                                                        <input formControlName="frequency" type="radio"
                                                            id="interval_stat" value="stat">
                                                        <span>Stat.</span>
                                                    </label>
                                                </div>
                                                <div *ngIf="!prescription['controls'].posology['controls'].interval['controls'].prn.value"
                                                    class="col-xs-12 ck-button">
                                                    <label>
                                                        <input formControlName="frequency" type="radio"
                                                            id="interval_morning" value="mor"><span>Mor</span>
                                                    </label>
                                                    <label>
                                                        <input formControlName="frequency" type="radio"
                                                            id="interval_midday" value="mid"><span>Noon</span>
                                                    </label>
                                                    <label>
                                                        <input formControlName="frequency" type="radio"
                                                            id="interval_Evening" value="eve"><span>Eve</span>
                                                    </label>
                                                    <label>
                                                        <input formControlName="frequency" type="radio"
                                                            id="interval_night" value="night"><span>Night</span>
                                                    </label>
                                                </div>
                                                <div *ngIf="prescription['controls'].posology['controls'].interval['controls'].times_hours.value == 'x'"
                                                    class="col-xs-12 ck-button">
                                                    <label>
                                                        <input formControlName="frequency" type="radio" id="interval_1X"
                                                            value="1">
                                                        <span>1X</span>
                                                    </label>
                                                    <label>
                                                        <input formControlName="frequency" type="radio" id="interval_2X"
                                                            value="2">
                                                        <span>2X</span>
                                                    </label>
                                                    <label>
                                                        <input formControlName="frequency" type="radio" id="interval_3X"
                                                            value="3">
                                                        <span>3X</span>
                                                    </label>
                                                    <label>
                                                        <input formControlName="frequency" type="radio" id="interval_4X"
                                                            value="4">
                                                        <span>4X</span>
                                                    </label>
                                                </div>
                                                <div *ngIf="prescription['controls'].posology['controls'].interval['controls'].times_hours.value == 'h' &&
                                                             (!prescription['controls'].posology['controls'].interval['controls'].prn.value)"
                                                    class="col-xs-12 ck-button">
                                                    <label>
                                                        <input formControlName="frequency" type="radio" id="interval_6H"
                                                            value="6">
                                                        <span>6H</span>
                                                    </label>
                                                    <label>
                                                        <input formControlName="frequency" type="radio" id="interval_8H"
                                                            value="8">
                                                        <span>8H</span>
                                                    </label>
                                                    <label>
                                                        <input formControlName="frequency" type="radio"
                                                            id="interval_12H" value="12">
                                                        <span>12H</span>
                                                    </label>
                                                    <label>
                                                        <input formControlName="frequency" type="radio"
                                                            id="interval_24H" value="24">
                                                        <span>24H</span>
                                                    </label>
                                                </div>
                                                <div class="col-xs-12 ck-button">
                                                    <input type="text" wholeNumber inputmode="numeric"
                                                        style="width: 50px;" formControlName="customfrequency"
                                                        (click)="ClearFrequency()" id="interval_custom">
                                                </div>
                                                <div class="col-xs-12 ck-button">
                                                    <label
                                                        *ngIf="!prescription['controls'].posology['controls'].interval['controls'].prn.value"
                                                        for="interval_X">
                                                        <input formControlName="times_hours" type="radio"
                                                            id="interval_X" value="x"><span>
                                                            X</span>
                                                    </label>
                                                    <label for="interval_H">
                                                        <input formControlName="times_hours" type="radio"
                                                            id="interval_H" value="h"><span>
                                                            H</span>
                                                    </label>
                                                    <label
                                                        *ngIf="prescription['controls'].posology['controls'].interval['controls'].prn.value"
                                                        for="interval_M">
                                                        <input formControlName="times_hours" type="radio"
                                                            id="interval_M" value="m"><span>
                                                            M</span>
                                                    </label>
                                                </div>
                                                <!-- </div> -->

                                            </div>
                                        </div>
                                        <!-- <div *ngIf="!prescription['controls'].posology['controls'].interval['controls'].prn.value"> -->
                                        <div *ngIf="formsettings.interval_type == 'standard' && !prescription['controls'].posology['controls'].interval['controls'].prn.value 
                                        && prescription['controls'].posology['controls'].interval['controls'].frequency.value != 'mor'
                                        && prescription['controls'].posology['controls'].interval['controls'].frequency.value != 'mid'
                                        && prescription['controls'].posology['controls'].interval['controls'].frequency.value != 'eve'
                                        && prescription['controls'].posology['controls'].interval['controls'].frequency.value != 'night'"
                                            [ngClass]="{'row mt-1 mb-1 dosingpatternpane':true, 'border rounded border-danger':!isStandardDosingPatternValid}"
                                            #intervalpattern>
                                            <div class="col-xs-12">
                                                <button type="button" class="btn btn-sm btn-secondary"
                                                    *ngIf="formsettings.dosing_pattern && formsettings.dosing_pattern.length"
                                                    (click)="SetDosingPatternFromNow()">Current time</button>
                                            </div>
                                            <div *ngFor="let ts of formsettings.dosing_pattern" #timeslot>
                                                <div class="col-xs-12 timeslot">
                                                    <!-- <label [ngxTimepicker]="fullTime" [format]="24" style="margin: 5px;">
                                            {{ ts.GetFormatString()}}
                                        </label>
                                        <ngx-material-timepicker [disableAnimation]="true" [theme]="darkTheme"
                                            [defaultTime]="ts.GetFormatString()" (timeSet)="timechange($event,ts)" #fullTime>
                                        </ngx-material-timepicker> -->

                                                    <label [appTimepicker]="fullTime" style="margin: 5px;">
                                                        {{ ts.GetFormatString()}}
                                                    </label>


                                                </div>
                                                <app-time-picker (setTimeTo)="ts.GetFormatString()"
                                                    (onTimeSelected)="timechange($event,ts)" #fullTime>
                                                </app-time-picker>
                                            </div>
                                        </div>
                                        <!-- </div> -->
                                        <!-- end interval pattern div -->

                                    </div>
                                    <!-- end interval div -->
                                </div>
                                <!-- end posology div -->

                                <!-- chosendays additional conditions row -->
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div formGroupName="posology">
                                            <div formGroupName="interval">
                                                <div class="pl-3 row">
                                                    <div class="col-xs-12" #cd
                                                        *ngIf="this.formsettings.infusionType !='ci'  && this.formsettings.infusionType != 'pca' && this.formsettings.interval_type !='protocol' && !prescription['controls'].posology['controls'].interval['controls'].prn.value">
                                                        <div class="chosendaysimage p-3" (click)="OpenChosenDaysForm()">
                                                        </div>
                                                    </div>
                                                    <div class="col-xs-12" #ac>
                                                        <div class="additionalconditionsimage p-3"
                                                            (click)="OpenAdditionalConditionsForm()">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row" *ngIf="this.formsettings.isInfusion && (this.formsettings.infusionType =='ci' || formsettings.infusionType == 'pca')  && this.formContext !='moa' && this.formContext !='mod' 
                                            && !formsettings.isOxygen">
                                    <div class="col-xs-12">
                                        <span *ngIf="this.formsettings.linkedinfusionid">
                                            <span class="h5">Linked to:</span> <small>(click to change)</small>
                                            <a class="h6" href="#" (click)="RemoveLinkedInfusion()">
                                                <span *ngIf="this.formsettings.linkedinfusionid">
                                                    Remove Link </span>
                                            </a>
                                            <br>
                                            <!-- <span style="text-decoration: none;">{{ linkedinfusionmedicationname}}</span> -->
                                            <div *ngFor="let p of therapyList">
                                                <div (click)="StartLinkedInfusionSelection()" class="border mb-1"
                                                    *ngIf="p.prescription_id == formsettings.linkedinfusionid">
                                                    <app-prescription-template [prescription]="p"
                                                        componenttype="medicationOrderSet">
                                                    </app-prescription-template>
                                                </div>
                                            </div>
                                            <div *ngFor="let p of appService.Prescription">
                                                <div (click)="StartLinkedInfusionSelection()" class="border mb-1"
                                                    *ngIf="p.prescription_id == formsettings.linkedinfusionid">
                                                    <app-prescription-template [prescription]="p"
                                                        componenttype="medicationOrderSet">
                                                    </app-prescription-template>
                                                </div>
                                            </div>
                                        </span>
                                        <a class="h6" href="#" (click)="StartLinkedInfusionSelection()">
                                            <span *ngIf="!this.formsettings.linkedinfusionid">
                                                Link Infusion
                                            </span>
                                        </a>
                                    </div>
                                </div>
                                <div class="text-danger small"> {{editingPrescriptionStartdateError}} </div>
                                <div class="row" #duration>
                                    <div *ngIf="showStartDate" class="col-xs-3">
                                        <label>
                                            <span class="small text-muted">Start Date</span>
                                        </label>
                                        <input type="text" style="width:8em;"
                                            [ngClass]="{'form-control mb-3':true,'border-danger':IsStartDateValid() }"
                                            placeholder="Start Date" formControlName="startdate" bsDatepicker
                                            [bsConfig]="{ showWeekNumbers:false, customTodayClass:'alert-info', dateInputFormat: 'DD-MM-YYYY', containerClass: 'theme-default', adaptivePosition: true }"
                                            [minDate]="minStartDate" #startdate />
                                    </div>
                                    <div *ngIf="showStartTime" class="col-xs-3 ml-1">
                                        <label>
                                            <span class="small text-muted">Time</span>
                                        </label>
                                        <select
                                            *ngIf="formsettings.infusionType != 'ci' && formsettings.infusionType != 'pca'  && !prescription['controls'].posology['controls'].interval['controls'].prn.value"
                                            formControlName="starttime"
                                            [ngClass]="{'form-control':true,'border-danger':IsStartTimeValid() }"
                                            id="ddlstarttime" #starttime>
                                            <option value=""></option>
                                            <option (reset)="ResetStartTime()" (load)="ResetStartTime()"
                                                [value]="ts.GetFormatString()"
                                                *ngFor="let ts of formsettings.dosing_pattern">
                                                {{ts.GetFormatString()}}</option>
                                        </select>
                                        <div
                                            *ngIf="formsettings.infusionType == 'ci' || formsettings.infusionType == 'pca' || prescription['controls'].posology['controls'].interval['controls'].prn.value">
                                            <input type="text" style="width:7em;" placeholder="Start Time"
                                                formControlName="starttime"
                                                [ngClass]="{'form-control mb-3':true, 'border-danger':IsStartTimeValid()}"
                                                [appTimepicker]="starttimets" />
                                            <app-time-picker (setTimeTo)="prescription['controls'].starttime.value"
                                                (onTimeSelected)="SetObjectiveFormValue('starttime',$event)"
                                                #starttimets>
                                            </app-time-picker>
                                        </div>
                                    </div>
                                    <div class="col-xs-3 ml-1" *ngIf="ShowDurationSizeInputControl()">
                                        <label>
                                            <span> <br></span>
                                        </label>
                                        <input type="text" wholeNumber inputmode="numeric" placeholder="No. of"
                                            style="width:5em;" formControlName="prescriptiondurationsize"
                                            [ngClass]="{'form-control':true, 'border-danger':IsDurationSizeValid()}"
                                            id=" txtdurationsize" />
                                    </div>
                                    <div class="col-xs-3 ml-1" *ngIf="ShowEndDateTimeInputControl()">
                                        <label>
                                            <span class="small text-muted">Last Dose Date</span>
                                        </label>
                                        <input type="text" style="width:8em;"
                                            [ngClass]="{'form-control mb-3':true, 'border-danger':IsEndDateValid()}"
                                            placeholder="End Date" formControlName="enddate" bsDatepicker
                                            [bsConfig]="{ showWeekNumbers:false, customTodayClass:'alert-info',  dateInputFormat: 'DD-MM-YYYY', containerClass: 'theme-default', adaptivePosition: true }"
                                            #enddate />
                                    </div>
                                    <div class="col-xs-12 ml-1" *ngIf="ShowEndDateTimeInputControl()">
                                        <label>
                                            <span class="small text-muted">Time</span>
                                        </label>
                                        <!-- <input type="text" style="width:6em;" placeholder="End Time" formControlName="endtime"
                                    [ngClass]="{'form-control mb-3':true, 'border-danger':IsEndTimeValid()}"
                                    [ngxTimepicker]="endTime" [format]="24" />
                                <ngx-material-timepicker [disableAnimation]="true" [theme]="darkTheme" #endTime>
                                </ngx-material-timepicker> -->

                                        <input type="text" style="width:6em;" placeholder="End Time"
                                            formControlName="endtime"
                                            [ngClass]="{'form-control mb-3':true, 'border-danger':IsEndTimeValid()}"
                                            [appTimepicker]="endTime" />
                                        <app-time-picker (setTimeTo)="prescription['controls'].endtime.value"
                                            (onTimeSelected)="SetObjectiveFormValue('endtime',$event)" #endTime>
                                        </app-time-picker>
                                    </div>
                                    <div *ngIf="showDuration" class="col-xs-12 ml-1">
                                        <label>
                                            <span *ngIf="formContext =='mod'" class="small text-muted">Duration</span>
                                            <span *ngIf="formContext !='mod'" class="small text-muted">Duration of
                                                treatment</span>

                                        </label>
                                        <select formControlName="prescriptionduration" class="form-control"
                                            id="ddlduration">
                                            <option [value]="dr.prescriptionduration_id" *ngFor="let dr of durations">
                                                {{dr.duration}}</option>
                                        </select>
                                    </div>
                                    <button type="button"
                                        *ngIf="formContext!='moa'  && formsettings.interval_type=='protocol'"
                                        class="btn btn-sm btn-link" (click)="OpenVariableForm()">
                                        View Protocol
                                    </button>
                                    <div *ngIf="showTotalQuantity" class="col-xs-12 ml-1">
                                        <label>
                                            <span class="small text-muted">Total Quantity</span>
                                        </label>
                                        <input
                                            *ngIf="formsettings.dose_type != 'descriptive' && formsettings.medication.productType.toLowerCase() !='vtm'"
                                            type="number" positiveNumbersOnly style="width:8em;"
                                            [ngClass]="{'form-control mb-3':true, 'border-danger':IsTotalQuantityValid()}"
                                            placeholder="Quantity" formControlName="totalquantity" #totalquantity />
                                        <input
                                            *ngIf="formsettings.dose_type == 'descriptive' || formsettings.medication.productType.toLowerCase() =='vtm'"
                                            type="text" style="width:12em;"
                                            [ngClass]="{'form-control mb-3':true, 'border-danger':IsTotalQuantityTextValid()}"
                                            placeholder="Quantity" formControlName="totalquantitytext"
                                            #totalquantitytext />
                                    </div>
                                    <div *ngIf="showTotalQuantity && formsettings.medication.productType.toLowerCase() !='vtm'"
                                        class="col-xs-12 ml-1">
                                        <label>
                                            <span class="small text-muted p-1"></span>
                                        </label><br>
                                        <label class="p-1 btn-sm font-weight-bold"
                                            *ngIf="formsettings.dose_type == 'units'">
                                            {{formsettings.dose_units}} </label>
                                        <label class="p-1 btn-sm font-weight-bold"
                                            *ngIf="formsettings.dose_type == 'strength'">
                                            {{formsettings.dose_strength_denominator_units}} </label>
                                        <label class="p-1 btn-sm font-weight-bold"
                                            *ngIf="formsettings.dose_type == 'descriptive'">
                                            {{formsettings.uom}} </label>
                                    </div>
                                    <div class="col-xs-12 ml-1" *ngIf="ShowEndDateTimeLabel()">
                                        <label>
                                            <span class="small text-muted">Last Dose Date-Time </span>
                                        </label><br>
                                        <label>
                                            ({{prescription['controls'].enddate.value | date:'dd-MM-yyyy' + " " +
                                            prescription['controls'].endtime.value}})
                                        </label>
                                    </div>

                                </div>
                                <!-- end duration div -->
                                <div class="row mt-n1" *ngIf="formContext!='moa' && formContext!='mod'">
                                    <label class="ml-2" #firstadmsg></label>
                                </div>
                                <div class="row">
                                    <span *ngFor="let ac of formsettings.additionalconditions">

                                        <label class="ml-2"
                                            *ngIf="prescription['controls'].additionalconditions.value ==ac.value ">
                                            <b>Additional Conditions: </b>{{ac.name}}
                                        </label>
                                    </span>
                                </div>
                                <div class="row" *ngIf="prescription['controls'].chosendays.value == 'skip'">
                                    <label class="ml-2">
                                        <b>Chosen Days: </b>
                                        Every {{ prescription['controls'].dosingdaysfrequencysize.value }} {{
                                        prescription['controls'].dosingdaysfrequency.value }}
                                    </label>
                                </div>
                                <div class="row" *ngIf="prescription['controls'].chosendays.value == 'chosen'">

                                    <label class="ml-2 mr-1"> <b>Chosen Days: </b>
                                        Every -
                                    </label>
                                    <span *ngFor="let d of checkedDaysOfWeekCount; let i = index;">
                                        <label>{{d.name}}<label class="mr-1"
                                                *ngIf="i < checkedDaysOfWeekCount.length-1">, </label></label>
                                    </span>

                                </div>
                                <div class="row"
                                    *ngIf="(formsettings.isAntibiotic || formsettings.isAntiviral) && showAntiMicrobialStartDate">
                                    <label>
                                        <span class="small text-muted">Antimicrobial Therapy Start Datetime</span>
                                    </label>
                                </div>
                                <div class="row"
                                    *ngIf="(formsettings.isAntibiotic || formsettings.isAntiviral) && showAntiMicrobialStartDate">
                                    <div class="col-xs-3">
                                        <input type="text" style="width:8em;"
                                            [ngClass]="{'form-control mb-3':true, 'border-danger':IsAMTDateValid()}"
                                            placeholder="Start Date" formControlName="antimicrobialstartdate"
                                            bsDatepicker
                                            [bsConfig]="{  showWeekNumbers:false, customTodayClass:'alert-info' , dateInputFormat: 'DD-MM-YYYY', containerClass: 'theme-default', adaptivePosition: true }"
                                            #startdate />
                                    </div>
                                    <div class="col-xs-3 ml-1">
                                        <!-- <input type="text" style="width:6em;" placeholder="Time"
                                    formControlName="antimicrobialstarttime" [ngClass]="{'form-control mb-3':true}"
                                    [ngxTimepicker]="amstarttimets" [format]="24" />
                                <ngx-material-timepicker [disableAnimation]="true" [theme]="darkTheme" #amstarttimets>
                                </ngx-material-timepicker> -->
                                        <input type="text" style="width:6em;" placeholder="Time"
                                            formControlName="antimicrobialstarttime"
                                            [ngClass]="{'form-control mb-3':true, 'border-danger':IsAMTimeValid()}"
                                            [appTimepicker]="amstarttimets" />
                                        <app-time-picker
                                            (setTimeTo)="prescription['controls'].antimicrobialstarttime.value"
                                            (onTimeSelected)="SetObjectiveFormValue('antimicrobialstarttime',$event)"
                                            #amstarttimets>
                                        </app-time-picker>
                                    </div>
                                </div>
                                <!-- <app-demo-chart *ngIf="prescriptionillustration"
                                    [Prescription]="prescriptionillustration">
                                </app-demo-chart> -->

                                <div class="row" #comments>
                                    <div class="col-xs-12 headerlabeldiv  text-muted" style="width: 45%;">
                                        <label>
                                            <span>Indications</span>
                                        </label>
                                        <select formControlName="indication"
                                            [ngClass]="{'form-control':true, 'border-danger':IsIndicationValid()}"
                                            id="ddlprescriptionindications">
                                            <option value="">
                                                Please select</option>
                                            <option [value]="pi.code" *ngFor="let pi of formsettings.indications">
                                                {{pi.indication}}</option>
                                        </select>
                                        <input placeholder="Enter Other Indications"
                                            [ngClass]="{'form-control mt-1':true, 'border-danger':IsOtherIndicationsValid()}"
                                            *ngIf="prescription['controls'].indication.value=='other'" type="text"
                                            formControlName="otherindications" />

                                        <br>

                                        <label *ngIf="showPrescriptionSource">
                                            <span>Prescription Source</span>
                                        </label>


                                        <div [ngClass]="{'col-xs-12':true}">
                                            <select *ngIf="showPrescriptionSource" formControlName="prescriptionsource"
                                                class="form-control mt-1" id="ddlprescriptionsource">
                                                <option value="">
                                                    Add Source</option>
                                                <option [hidden]="ps.selected" [value]="ps.prescriptionsource_id"
                                                    *ngFor="let ps of formsettings.sources">
                                                    {{ps.displayname}}</option>

                                            </select>

                                            <!-- <table class="table table-sm table-borderless"> 
                                            <tr *ngFor="let s of formsettings.sources">
                                                <td *ngIf="s.selected" class="text-info">{{s.source}} <b
                                                        (click)="SourceChanged(false,s)" class="float-right h4">✖</b></td>
                                            </tr>
                                        </table> -->
                                            <ul class="list-group">
                                                <span *ngFor="let s of formsettings.sources">
                                                    <li *ngIf="s.selected" class="list-group-item">
                                                        <span>
                                                            {{s.source}}
                                                            <b *ngIf="(!this.editingPrescription) || (this.editingPrescription && !this.editingPrescription.__GpConnect)"
                                                                (click)="SourceChanged(false,s)"
                                                                class="float-right h4">✖</b>
                                                        </span>
                                                    </li>
                                                </span>
                                            </ul>
                                            <input placeholder="Enter Other Source"
                                                [ngClass]="{'form-control mt-1':true}" *ngIf="ShowOtherSourceControl()"
                                                type="text" formControlName="otherprescriptionsource" />
                                            <span *ngIf="IsPrescriptionOtherSourceValid()"
                                                class="small text-danger">Please
                                                enter less than
                                                256 characters</span>
                                        </div>
                                        <br>
                                        <label *ngIf="showDispensingFrom">
                                            <span>Dispensing From</span>
                                        </label>
                                        <select *ngIf="showDispensingFrom" formControlName="dispensingfrom"
                                            [ngClass]="{'form-control':true, 'border-danger':IsDispensingFromValid()}">
                                            <option value="pharmacy">
                                                Pharmacy</option>
                                        </select>

                                    </div>
                                    <div class="col headerlabeldiv  text-muted ml-2" style="width: 45%;">
                                        <label>
                                            <span>Comments</span>
                                        </label>
                                        <!-- <input type="text" class="form-control" formControlName="comments" /> -->
                                        <textarea
                                            [ngClass]="{'form-control':true, 'border-danger':IsPrescriptionCommentsValid()}"
                                            formControlName="comments"
                                            style="height: 15em; width: 100%; overflow: auto;">
                            </textarea>
                                        <span *ngIf="IsPrescriptionCommentsValid()" class="small text-danger">Please
                                            enter less than
                                            {{prescriptionCommentsMaxLength}} characters</span>
                                    </div>


                                </div>

                                <div *ngIf="showReviewStatus && editingPrescription && !clonePrescription && (formContext=='ip' || formContext=='mod') "
                                    class="row mt-2" #review>
                                    <div class="col-xs-12 headerlabeldiv  text-muted" style="width: 45%;">
                                        <!-- <label>
                                    <span>Current Review Status</span>
                                </label> -->
                                        <!-- <div class="row">
                                    <div class="col-md-1">
                                        <div [ngClass]="{
                                        'p-3':true, 
                                        'reviewstatus_grey_image':formsettings.currentreviewstatus.status =='Grey',
                                        'reviewstatus_green_image':formsettings.currentreviewstatus.status=='Green',
                                        'reviewstatus_amber_image':formsettings.currentreviewstatus.status=='Amber',
                                        'reviewstatus_red_image':formsettings.currentreviewstatus.status=='Red'
                                    }">
                                        </div>
                                    </div>
                                    <div class="col ml-1 small align-self-center">
                                        {{formsettings.currentreviewstatus.description}}
                                    </div>
                                </div> -->
                                        <label>
                                            <span>Review Status</span>
                                        </label>
                                        <br>
                                        <div class="row dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                                            aria-expanded="false" style="text-decoration: underline;">
                                            <div class="col-md-1 btn-group dropright">
                                                <label>
                                                    <span *ngIf="!formsettings.currentreviewstatus">Select</span>
                                                    <img *ngIf="formsettings.currentreviewstatus" [ngClass]="{
                                                'p-3':true, 
                                                'reviewstatus_grey_image':formsettings.currentreviewstatus.status =='Grey',
                                                'reviewstatus_green_image':formsettings.currentreviewstatus.status=='Green',
                                                'reviewstatus_amber_image':formsettings.currentreviewstatus.status=='Amber',
                                                'reviewstatus_red_image':formsettings.currentreviewstatus.status=='Red'
                                            }" />
                                                </label>

                                            </div>
                                            <div class="col align-self-center"> <span class="ml-1 small text-wrap"
                                                    *ngIf="formsettings.currentreviewstatus">{{formsettings.currentreviewstatus.description}}</span>
                                            </div>

                                        </div>
                                        <div class="dropdown-menu">
                                            <a *ngFor="let rs of appService.MetaReviewstatus" class="dropdown-item"
                                                (click)="SetChangedReviewStatus(rs);" href="#">
                                                <img [ngClass]="{
                                                'p-3':true, 
                                                'reviewstatus_grey_image':rs.status.toLowerCase() =='grey',
                                                'reviewstatus_green_image':rs.status.toLowerCase()=='green',
                                                'reviewstatus_amber_image':rs.status.toLowerCase()=='amber',
                                                'reviewstatus_red_image':rs.status.toLowerCase()=='red'
                                            }" />
                                                {{rs.description}}
                                            </a>
                                        </div>


                                    </div>
                                    <div class="col headerlabeldiv  text-muted ml-2" style="width: 45%;">
                                        <label>
                                            <span>Review Comments</span>
                                        </label>
                                        <textarea
                                            [ngClass]="{'form-control':true, 'border-danger':IsReviewCommentsValid()}"
                                            formControlName="reviewcomments"
                                            style="height: 11em; width: 100%; overflow: auto;">
                            </textarea>
                                        <span
                                            *ngIf="prescription['controls'].reviewcomments.errors?.invalid_reviewcomments_size"
                                            class="small text-danger">Please
                                            enter less than
                                            {{reviewCommentsMaxLength}} characters</span>
                                    </div>
                                </div>

                                <div class="row mt-3" #source>
                                    <div class="col-xs-12"
                                        *ngIf="!formsettings.isInfusion ||  formsettings.infusionType == 'bolus' ">
                                        <label>
                                            <span class="small text-muted">Calculations</span>
                                        </label>
                                        <div *ngIf="appService.refWeightValue>0 && (doseperkg || doseperkgperday)">
                                            <span
                                                *ngIf="doseperkg && formsettings.interval_type == 'standard'"><b>{{doseperkg}}</b>
                                                {{doseunitsdisplaytext}}/kg/dose</span>
                                            <!-- <br *ngIf="doseperkg && formsettings.interval_type == 'standard'"> -->
                                            <span class="ml-2" *ngIf="doseperkgperday"><b>{{doseperkgperday}}
                                                </b>{{doseunitsdisplaytext}}/kg/day</span>
                                            <b>(<span
                                                    *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                    *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                Weight)</b>

                                        </div>
                                        <div *ngIf="appService.idealWeightValue>0 && (doseperikg || doseperikgperday)">
                                            <span
                                                *ngIf="doseperkg && formsettings.interval_type == 'standard'"><b>{{doseperikg}}</b>
                                                {{doseunitsdisplaytext}}/kg/dose</span>
                                            <!-- <br *ngIf="doseperkg && formsettings.interval_type == 'standard'"> -->
                                            <span class="ml-2" *ngIf="doseperikgperday"><b>{{doseperikgperday}}
                                                </b>{{doseunitsdisplaytext}}/kg/day </span>
                                            <b>(Ideal body weight)</b>
                                        </div>
                                        <div *ngIf="appService.bodySurfaceArea>0  && (doseperm2 || doseperm2perday)">
                                            <span
                                                *ngIf="doseperm2 && formsettings.interval_type == 'standard'"><b>{{doseperm2}}</b>
                                                {{doseunitsdisplaytext}}/m2/dose</span>
                                            <!-- <br *ngIf="doseperkg && formsettings.interval_type == 'standard'"> -->
                                            <span class="ml-2" *ngIf="doseperm2perday"><b>{{doseperm2perday}}
                                                </b>{{doseunitsdisplaytext}}/m2/day</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br>
                            <div class="modal-footer" style="padding: 5px 5px;">
                                <button *ngIf="!this.editingPrescription" type="submit" class="btn btn-info btn-sm"
                                    style="color:white" [disabled]="false">Add
                                </button>
                                <button type="submit" *ngIf="this.editingPrescription" style="color:white"
                                    class="btn btn-info btn-sm" [disabled]="isFormSaving">
                                    <span class="spinner-border spinner-border-sm" *ngIf="isFormSaving" role="status"
                                        aria-hidden="true">
                                    </span>
                                    <span *ngIf="!clonePrescription && formContext != 'ip'">Add</span>
                                    <!-- moa, mod, op edit prescriptino-->
                                    <span *ngIf="!clonePrescription && formContext == 'ip'">Prescribe</span>
                                    <!-- ip edit prescriptino-->
                                    <span *ngIf="clonePrescription">Add</span>
                                    <!-- add from orderset, copy prescription from drugchart-->
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm" [disabled]="isFormSaving"
                                    (click)="CancelPrescription()">Cancel</button>
                                <button type="button" class="btn btn-secondary btn-sm" [disabled]="isFormSaving"
                                    (click)="ClearForm()">Clear</button>
                            </div>
                        </div>
                        <div style="padding-left: 35px;" *ngIf="iseditingvariable" #variabledose>
                            <div class="row">
                                <div class="col-xs-12 headerlabeldiv mb-1 font-weight-bold">
                                    <label>
                                        <span>Variable Dosing</span>
                                    </label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="btn-group dropright">
                                    <img [hidden]="!(appService.refWeightValue && formsettings.medication.formularyIngredients)"
                                        class="dropdown-toggle Calculatorddl" data-toggle="dropdown"
                                        aria-haspopup="true" aria-expanded="false" />
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item"
                                            (click)="SetCalculatorType('kg');UpdateCalculatorInputForVariableDose(formsettings);"
                                            href="#">{{doseunitsdisplaytext}}/kg/dose (<span
                                                *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                            Weight)</a>
                                        <a class="dropdown-item" *ngIf="appService.idealWeightValue>0"
                                            (click)="SetCalculatorType('ikg');UpdateCalculatorInputForVariableDose(formsettings)"
                                            href="#">{{doseunitsdisplaytext}}/kg/dose
                                            (Ideal body weight)</a>
                                        <a class="dropdown-item" *ngIf="appService.bodySurfaceArea>0"
                                            (click)="SetCalculatorType('m2');UpdateCalculatorInputForVariableDose(formsettings)"
                                            href="#">{{doseunitsdisplaytext}}/m2/dose</a>
                                        <a class="dropdown-item" (click)="SetCalculatorType('null')" href="#">No
                                            Calculator</a>

                                    </div>
                                    <div formGroupName="posology" class="ml-1 mt-n1"
                                        *ngIf="formsettings.medication.productType.toLowerCase() =='vtm' || formsettings.vtmstyle">
                                        <div formGroupName="strength">
                                            <select (change)="VtmUnitsChanged()" formControlName="dose_units"
                                                class="form-control">
                                                <option [value]="un" *ngFor="let un of formsettings.vtm_dose_units">
                                                    {{un}}
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="row">
                                <div class="col-xs-12 headerlabeldiv  text-muted">
                                    <label>
                                        <span>Dosage Interval</span>
                                    </label>
                                </div>
                            </div>
                            <div formGroupName="posology">
                                <div class="row" formGroupName="interval">
                                    <ng-template [ngTemplateOutlet]="frequencytemplate">
                                    </ng-template>
                                    <button type="button" class="btn btn-sm btn-link" (click)="OpenProtocolForm()">
                                        Protocol
                                    </button>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-xs-12 headerlabeldiv  text-muted">
                                        <label>
                                            <span>Posology</span>
                                        </label>
                                    </div>
                                </div>
                                <div style="max-height: 500px; overflow-y: auto; overflow-x: hidden;">
                                    <div class="row" *ngFor="let ts of formsettings.dosing_pattern">
                                        <div class="col-sm-2">
                                            <!-- <label class="btn btn-sm border bg-light rounded" [ngxTimepicker]="fullTime_v"
                                        [format]="24">
                                        {{ ts.GetFormatString()}}
                                    </label>
                                    <ngx-material-timepicker [disableAnimation]="true" [theme]="darkTheme"
                                        [defaultTime]="ts.GetFormatString()" (timeSet)="timechange($event,ts)" #fullTime_v>
                                    </ngx-material-timepicker> -->


                                            <label class="btn btn-sm border bg-light rounded"
                                                [appTimepicker]="fullTime_v">
                                                {{ ts.GetFormatString()}}
                                            </label>
                                            <app-time-picker (setTimeTo)="ts.GetFormatString()"
                                                (onTimeSelected)="timechange($event,ts)" #fullTime_v>
                                            </app-time-picker>


                                        </div>
                                        <ng-template [ngTemplateOutlet]="dosetemplate"
                                            [ngTemplateOutletContext]="{ts:ts, fs:formsettings,context:''}">
                                        </ng-template>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <label class="text-danger" #variabledoseerror></label>
                                    </div>
                                </div>
                                <div class="row float-right mr-1 mb-1">
                                    <div class="col float-right ">
                                        <button type="button" class="btn btn-info btn-sm mr-1"
                                            (click)="SaveVariableEdit()">Save</button>
                                        <button type="button" class="btn btn-secondary btn-sm"
                                            (click)="CancelVariableEdit()">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="padding-left: 35px;" *ngIf="iseditingprotocol" #protocoldose>
                            <div class="row">
                                <div class="col-xs-12 headerlabeldiv mb-1 font-weight-bold">
                                    <label>
                                        <span>Variable Protocol Dosing</span>
                                    </label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 headerlabeldiv  text-muted">
                                    <label>
                                        <span>Dosage Interval</span>
                                    </label>
                                </div>
                            </div>
                            <div formGroupName="posology">
                                <div class="row" formGroupName="interval">
                                    <ng-template [ngTemplateOutlet]="frequencytemplate">
                                    </ng-template>
                                </div>

                                <div class="row">
                                    <div class="col-xs-12 headerlabeldiv  text-muted">
                                        <label>
                                            <span>Posology</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="row">
                                    <label class="p-1 btn-sm rounded">
                                        Please prescribe in </label>
                                    <span
                                        *ngIf="formsettings.medication.productType.toLowerCase() !='vtm' && !formsettings.vtmstyle">
                                        <label class="p-1 h6 font-weight-bold"
                                            *ngIf="formsettings.dose_type == 'units'">
                                            {{formsettings.dose_units}} </label>
                                        <label class="p-1 h6 font-weight-bold"
                                            *ngIf="formsettings.dose_type == 'strength'">
                                            {{formsettings.dose_strength_neumerator_units}} </label>
                                        <label class="m-n1 h6 font-weight-bold"
                                            *ngIf="formsettings.dose_type == 'strength'" style="font-size: 1em;"> /
                                        </label>
                                        <label class="p-1 h6 font-weight-bold"
                                            *ngIf="formsettings.dose_type == 'strength'">
                                            {{formsettings.dose_strength_denominator_units}} </label>
                                    </span>
                                    <span formGroupName='strength'
                                        *ngIf="formsettings.medication.productType.toLowerCase() =='vtm' || formsettings.vtmstyle">
                                        <select (change)="VtmUnitsChanged()" formControlName="dose_units">
                                            <option [value]="un" *ngFor="let un of formsettings.vtm_dose_units">
                                                {{un}}
                                            </option>
                                        </select>
                                    </span>
                                    <label class="p-1 btn-sm rounded">
                                        the dose for each day. </label>
                                </div>
                                <div class="row">
                                    <input class="p-1 m-1 btn-sm border rounded" inputmode="numeric" positiveNumbersOnly
                                        (change)="RoundPrescribingDose(null,formsettings);StrengthToUnitDose(null,true,formsettings); Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['totalstrengthprotocol','posology.strength.calculatorinput']);"
                                        style=" width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                        type="text" #copydose>
                                    <label class="ml-n2 btn-sm font-weight-bold"
                                        *ngIf="formsettings.dose_type == 'units'">
                                        {{formsettings.dose_units}} </label>
                                    <label class="ml-n2 btn-sm font-weight-bold"
                                        *ngIf="formsettings.dose_type == 'strength'">
                                        {{formsettings.dose_strength_neumerator_units}} </label>

                                    <input class="p-1 m-1 btn-sm border rounded"
                                        *ngIf="formsettings.isNeumeratorOnlyStrength" type="text" inputmode="numeric"
                                        positiveNumbersOnly
                                        (change)="StrengthToUnitDose(null,false,formsettings);RoundPrescribingDose(null,formsettings);StrengthToUnitDose(null,true,formsettings);Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['copydose','posology.strength.calculatorinput']);"
                                        style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                        #totalstrengthprotocol />
                                    <label class="font-weight-bold" *ngIf="formsettings.isNeumeratorOnlyStrength">
                                        {{formsettings.singleIngredientStrength}}
                                    </label>
                                    <button type="button" class="btn btn-sm btn-link" (click)="CopyDoseToProtocol()">
                                        Apply</button>
                                    <span class="btn-group dropright">
                                        <img [hidden]="!(appService.refWeightValue && formsettings.medication.formularyIngredients)"
                                            class="dropdown-toggle Calculatorddl ml-1" data-toggle="dropdown"
                                            aria-haspopup="true" aria-expanded="false" />

                                        <span class="dropdown-menu">
                                            <a class="dropdown-item"
                                                (click)="SetCalculatorType('kg');Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['posology.strength.calculatorinput']);"
                                                href="#">{{doseunitsdisplaytext}}/kg/dose (<span
                                                    *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                    *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                Weight)</a>
                                            <a class="dropdown-item" *ngIf="appService.idealWeightValue>0"
                                                (click)="SetCalculatorType('ikg');Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['posology.strength.calculatorinput']);"
                                                href="#">{{doseunitsdisplaytext}}/kg/dose
                                                (Ideal body weight)</a>
                                            <a class="dropdown-item" *ngIf="appService.bodySurfaceArea>0"
                                                (click)="SetCalculatorType('m2');Calculator_DosePerKgM2('1',null,formsettings);FixDecimalPlaces(['posology.strength.calculatorinput']);"
                                                href="#">{{doseunitsdisplaytext}}/m2/dose</a>
                                            <a class="dropdown-item" (click)="SetCalculatorType('null')" href="#">No
                                                Calculator</a>

                                        </span>
                                    </span>
                                </div>
                                <div class="row">
                                    <span formGroupName='strength'
                                        *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value!='null'"
                                        class="ml-1">
                                        <input class="btn-sm border rounded" type="text" inputmode="numeric"
                                            positiveNumbersOnly
                                            (change)="Calculator_DosePerKgM2('2',null,formsettings);RoundPrescribingDose(null,formsettings);StrengthToUnitDose(null,true,formsettings);FixDecimalPlaces(['totalstrengthprotocol','copydose']);"
                                            style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                            formControlName="calculatorinput" enterIsNext />
                                    </span>
                                    <span
                                        *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value!='null'"
                                        class="ml-n1 btn-sm">
                                        <label> {{doseunitsdisplaytext}}
                                            <span
                                                *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'kg'">/kg/dose
                                                (<span
                                                    *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                    *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                Weight)</span>
                                            <span
                                                *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'ikg'">/kg/dose
                                                (Ideal body weight)</span>
                                            <span
                                                *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'm2'">/m2/dose</span>
                                        </label>
                                    </span>


                                </div>

                                <div class="row" style="max-width:90%; max-height: 400px; overflow: auto;">
                                    <table>
                                        <tr *ngFor="let row of protocolHTMLBinder">
                                            <td *ngFor="let col of row;let i = index;">
                                                <div *ngIf="col.type=='dateselectcell'">
                                                    <!-- <label class="btn btn-sm border bg-light rounded" bsDatepicker
                                                (bsValueChange)="ProtocolStartDateChange($event)" [bsValue]="protocolstartdate"
                                                [bsConfig]="{ dateInputFormat: 'DD-MM-YYYY', containerClass: 'theme-default', adaptivePosition: true}">
                                                {{col.value | date:'dd/LLL'}} <br>{{col.value | date:'EEEEEE'}}
        
                                                Day {{i}}
                                            </label> -->

                                                    <label class="btn btn-sm rounded border font-weight-bold">

                                                        Day {{i}}
                                                    </label>

                                                </div>
                                                <div *ngIf="col.type=='datecell'">
                                                    <label class="btn btn-sm rounded border font-weight-bold">
                                                        Day {{i}}

                                                    </label>
                                                </div>
                                                <div *ngIf="col.type=='timecell'">
                                                    <!-- <label class="btn btn-sm border bg-light rounded" [ngxTimepicker]="fullTime_p"
                                                [format]="24" style="margin: 5px;">
                                                {{ col.value.GetFormatString()}}
                                            </label>
                                            <ngx-material-timepicker [disableAnimation]="true" [theme]="darkTheme"
                                                [defaultTime]="col.value.GetFormatString()"
                                                (timeSet)="timechangeprotocol($event,col.value)" #fullTime_p>
                                            </ngx-material-timepicker> -->

                                                    <label class="btn btn-sm border bg-light rounded"
                                                        [appTimepicker]="fullTime_p" style="margin: 5px;">
                                                        {{ col.value.GetFormatString()}}
                                                    </label>
                                                    <app-time-picker (setTimeTo)="col.value.GetFormatString()"
                                                        (onTimeSelected)="timechangeprotocol($event,col.value)"
                                                        #fullTime_p>
                                                    </app-time-picker>

                                                </div>
                                                <div *ngIf="col.type=='dosecell'">
                                                    <ng-template [ngTemplateOutlet]="dosetemplate"
                                                        [ngTemplateOutletContext]="{ts:col.value, fs:formsettings,context:''}">
                                                    </ng-template>
                                                </div>
                                                <div *ngIf="col.type=='adddaycell'">
                                                    <button (click)="AddDayToProtocol()"
                                                        class="btn btn-default border btn-small"
                                                        type="button">+</button>
                                                </div>
                                                <div *ngIf="col.type=='removedaycell'">
                                                    <button (click)="RemoveDayFromProtocol()"
                                                        class="btn btn-default border btn-small"
                                                        type="button">-</button>
                                                </div>
                                                <div *ngIf="col.type=='addintervalcell'">
                                                    <button (click)="AddIntervalToProtocol()"
                                                        class="btn btn-default border btn-small"
                                                        type="button">+</button>
                                                </div>
                                                <div *ngIf="col.type=='removeintervalcell'">
                                                    <button (click)="RemoveIntervalFromProtocol()"
                                                        class="btn btn-default border btn-small"
                                                        type="button">-</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12 headerlabeldiv  text-muted">
                                        <label>
                                            <span>Repeat Protocol</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <select class="form-control" formControlName="repeatprotocol"
                                            id="ddlrepeatprotocol">
                                            <option value="none" selected>No Repeat</option>
                                            <option value="lastday">Last Day</option>
                                            <option value="protocol">Full Protocol</option>
                                        </select>
                                    </div>
                                    <div class="col-xs-12"
                                        *ngIf="prescription['controls'].posology['controls'].repeatprotocol.value == 'lastday'">
                                        <select class="form-control" formControlName="repeatprotocolsub"
                                            id="ddlrepeatprotocolsub">
                                            <!-- <option value="untilcancelled">
                                                Until
                                                Cancelled</option> -->
                                            <option value="enddate">End Date</option>
                                        </select>
                                    </div>
                                    <div class="col-xs-12"
                                        *ngIf="prescription['controls'].posology['controls'].repeatprotocol.value == 'lastday'
                                 && prescription['controls'].posology['controls'].repeatprotocolsub.value == 'enddate'">
                                        <input class="form-control" type="text" style="width:8em;"
                                            placeholder="Enter Date" formControlName="protocolenddate" bsDatepicker
                                            [bsConfig]="{  showWeekNumbers:false,customTodayClass:'alert-info',  dateInputFormat: 'DD-MM-YYYY', containerClass: 'theme-default', adaptivePosition: true }" />
                                    </div>
                                    <div class="col-xs-12"
                                        *ngIf="prescription['controls'].posology['controls'].repeatprotocol.value == 'protocol'">
                                        <input wholeNumber class="form-control" type="text" style="width:8em;"
                                            placeholder="No. of times" formControlName="protocolrepeattimes" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <label class="text-danger" #protocoldoseerror></label>
                                    </div>
                                </div>
                                <div class="row float-right mr-1 mb-1">
                                    <div class="col float-right ">
                                        <button type="button" class="btn btn-info btn-sm mr-1"
                                            (click)="SaveProtocolEdit()">Save</button>
                                        <button type="button" class="btn btn-secondary btn-sm"
                                            (click)="CancelProtocolEdit()">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--end protocol dose-->
                        <div style="padding-left: 35px;" [hidden]="!iseditinginfusionvariable" #variableinfusion>
                            <div class="row">
                                <div class="col-xs-12 headerlabeldiv mb-1 font-weight-bold">
                                    <label>
                                        <span>Variable Rate</span>
                                    </label>
                                </div>
                            </div>
                            <div class="row">
                                <!-- <div class="col-xs-12 headerlabeldiv small text-muted">
                            <label>
                                <span>Variable Rate</span>
                            </label>
                        </div> -->
                                <table style="width:80%">
                                    <tbody>
                                        <tr>
                                            <!-- <td class="col-xs-12 headerlabeldiv small text-muted">
                                        <label><span>Variable Rate</span></label>
                                    </td> -->
                                            <td [hidden]="formsettings.infusionType !=='rate'" class="col-xs-12">
                                                Total:
                                                <label class="font-weight-bold"><span #totalVolume></span></label>
                                                Prescribed:
                                                <label class="font-weight-bold"><span #prescribedVolume></span></label>
                                                Remaining:
                                                <label class="font-weight-bold"><span #remainingVolume></span></label>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- calculator for doserate variable form-->
                            <div class="row" *ngIf="infusionDoseRateUnits!='/hr'">
                                <div class="btn-group dropright">
                                    <img [hidden]="!(appService.refWeightValue && formsettings.medication.formularyIngredients)"
                                        class="dropdown-toggle Calculatorddl" data-toggle="dropdown"
                                        aria-haspopup="true" aria-expanded="false" />
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item"
                                            (click)="SetCalculatorType_doserate('kg');UpdateCalculatorInputForVariableDose_doserate(formsettings);"
                                            href="#">{{doseunitsdisplaytext}}/kg/hr (<span
                                                *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                            Weight)</a>
                                        <a class="dropdown-item" *ngIf="appService.idealWeightValue>0"
                                            (click)="SetCalculatorType_doserate('ikg');UpdateCalculatorInputForVariableDose_doserate(formsettings)"
                                            href="#">{{doseunitsdisplaytext}}/kg/hr
                                            (Ideal body weight)</a>
                                        <a class="dropdown-item" *ngIf="appService.bodySurfaceArea>0"
                                            (click)="SetCalculatorType_doserate('m2');UpdateCalculatorInputForVariableDose_doserate(formsettings)"
                                            href="#">{{doseunitsdisplaytext}}/m2/hr</a>
                                        <a class="dropdown-item" (click)="SetCalculatorType_doserate('null')"
                                            href="#">No
                                            Calculator</a>

                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <table>
                                    <tr>
                                        <td>
                                            <table>
                                                <tr *ngFor="let row of formsettings.infusion_rate_pattern">
                                                    <td>
                                                        <div *ngIf="DisableStartDateSelection(row) == false">
                                                            <!-- <label class="btn btn-sm border bg-light rounded"
                                                    [ngxTimepicker]="fullTime_startrate" [format]="24" style="margin: 5px;">
                                                    {{ row.starttime.GetFormatString()}}
                                                </label>
                                                <ngx-material-timepicker [disableAnimation]="true" [theme]="darkTheme"
                                                    [defaultTime]="row.starttime.GetFormatString()"
                                                    (timeSet)="timechange($event,row.starttime)" #fullTime_startrate>
                                                </ngx-material-timepicker> -->

                                                            <label class="btn btn-sm border bg-light rounded"
                                                                [appTimepicker]="fullTime_startrate"
                                                                style="margin: 5px;">
                                                                {{ row.starttime.GetFormatString()}}
                                                            </label>
                                                            <app-time-picker
                                                                (setTimeTo)="row.starttime.GetFormatString()"
                                                                (onTimeSelected)="timechange($event,row.starttime)"
                                                                #fullTime_startrate>
                                                            </app-time-picker>
                                                        </div>
                                                        <div *ngIf="DisableStartDateSelection(row) == true">
                                                            <label class="btn btn-sm border bg-light rounded"
                                                                style="margin: 5px;">
                                                                {{ row.starttime.GetFormatString()}}
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div *ngIf="!(ShowUntilCancelledCheckBox(row) && prescription['controls'].civariableuntilcancelled.value)"
                                                            class="col-xs-12">
                                                            <label style="margin: 5px;">
                                                                Until </label>
                                                        </div>
                                                    </td>
                                                    <td style="vertical-align:baseline;"
                                                        [attr.rowspan]="ShowUntilCancelledCheckBox(row)?2:1">
                                                        <div
                                                            *ngIf="!(ShowUntilCancelledCheckBox(row) && prescription['controls'].civariableuntilcancelled.value)">
                                                            <!-- <label class="btn btn-sm border bg-light rounded"
                                                            [ngxTimepicker]="fullTime_endrate" [format]="24" style="margin: 5px;">
                                                            {{ row.endtime.GetFormatString()}}
                                                        </label>
                                                        <ngx-material-timepicker [disableAnimation]="true" [theme]="darkTheme"
                                                            [defaultTime]="row.endtime.GetFormatString()"
                                                            (timeSet)="timechange($event,row.endtime)" #fullTime_endrate>
                                                        </ngx-material-timepicker> -->

                                                            <label class="btn btn-sm border bg-light rounded"
                                                                [appTimepicker]="fullTime_endrate" style="margin: 5px;">
                                                                {{ row.endtime.GetFormatString()}}
                                                            </label>
                                                            <app-time-picker (setTimeTo)="row.endtime.GetFormatString()"
                                                                (onTimeSelected)="timechange($event,row.endtime)"
                                                                #fullTime_endrate>
                                                            </app-time-picker>
                                                        </div>
                                                        <label class="ml-n5 p-1 pt-2"
                                                            [hidden]="!ShowUntilCancelledCheckBox(row)">
                                                            <input
                                                                (change)="ToggleCIVariableUntilCancelled(row.endtime)"
                                                                formControlName="civariableuntilcancelled"
                                                                type="checkbox">
                                                            <span class="small pl-1">Until Cancelled</span>
                                                        </label>
                                                    </td>
                                                    <td>

                                                        <input type="number" inputmode="numeric" positiveNumbersOnly
                                                            (input)="row.starttime.infusionrate = $event.target.value"
                                                            (change)="RateToDoseRateTS(false, row.starttime); Calculator_DoseRatePerKgM2('1',row.starttime, formsettings); SetVariableInfusionVolumeLabels(row);FixDecimalPlaces(['infusiondoserate','calculatorinput_doserate'],row.starttime);"
                                                            [value]="GetVariableInfusionRateInputText(row.starttime)"
                                                            style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                            [ngClass]="{'form-control':true, 'border-danger':IsDoseValid()}" />


                                                    </td>
                                                    <td><label> {{formsettings.infusionrateunits}} </label></td>
                                                    <td *ngIf="infusionDoseRateUnits!='/hr'">
                                                        <input type="number" inputmode="numeric" positiveNumbersOnly
                                                            (input)="row.starttime.infusiondoserate = $event.target.value"
                                                            (change)="RateToDoseRateTS(true, row.starttime); Calculator_DoseRatePerKgM2('1',row.starttime, formsettings); SetVariableInfusionVolumeLabels(row);FixDecimalPlaces(['infusionrate','calculatorinput_doserate'],row.starttime);"
                                                            [value]="GetVariableInfusionDoseRateInputText(row.starttime)"
                                                            style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                            [ngClass]="{'form-control':true, 'border-danger':IsDoseValid()}" />
                                                    </td>
                                                    <td *ngIf="infusionDoseRateUnits!='/hr'"><label>
                                                            {{infusionDoseRateUnits}} </label>
                                                    </td>
                                                    <td *ngIf="infusionDoseRateUnits!='/hr'">
                                                        <div formGroupName='posology'>
                                                            <div formGroupName='strength'
                                                                *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype_doserate.value!='null'"
                                                                class="col-xs-12 ml-1">
                                                                <input type="text" inputmode="numeric"
                                                                    positiveNumbersOnly
                                                                    (change)="Calculator_DoseRatePerKgM2('2',row.starttime,formsettings);RateToDoseRateTS(true, row.starttime);FixDecimalPlaces(['infusiondoserate','infusionrate'],row.starttime); "
                                                                    (input)="row.starttime.calculatorinput_doserate = $event.target.value"
                                                                    [value]="row.starttime.calculatorinput_doserate ? row.starttime.calculatorinput_doserate : ''"
                                                                    style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                                    enterIsNext [ngClass]="{'form-control':true}" />
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype_doserate.value!='null'"
                                                            class="col-xs-12"
                                                            style="margin-top: 0.8em;margin-left: 0.2em;">
                                                            <label> {{doseunitsdisplaytext}}
                                                                <span class="ml-n1"
                                                                    *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype_doserate.value == 'kg'">/kg/hr
                                                                    (<span
                                                                        *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                                        *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                                    Weight)</span>
                                                                <span class="ml-n1"
                                                                    *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype_doserate.value == 'ikg'">/kg/hr
                                                                    (Ideal body weight)</span>
                                                                <span class="ml-n1"
                                                                    *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype_doserate.value == 'm2'">/m2/hr</span>
                                                            </label>
                                                        </div>
                                                    </td>



                                                </tr>
                                                <tr>
                                                    <td style="padding: 15px;"></td>
                                                </tr>
                                            </table>

                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="row">
                                            <div class="col-xs-12">
                                                <button [hidden]="DisableAddInfusionInterval()"
                                                    (click)="AddIntervalToInfusionRate()"
                                                    class="btn btn-default border btn-small" type="button">+</button>
                                            </div>
                                            <div class="col-xs-12">
                                                <button (click)="RemoveIntervalFromInfusionRate()"
                                                    class="btn btn-default border btn-small" type="button">-</button>
                                            </div>
                                        </td>
                                    </tr>
                                </table>

                            </div>
                            <div class="row">
                                <div class="col">
                                    <label class="text-danger" #variableinfusionerror></label>
                                </div>
                            </div>
                            <div class="row float-right mr-1 mb-1">
                                <div class="col float-right ">
                                    <button type="button" class="btn btn-info btn-sm mr-1"
                                        (click)="SaveVariableInfusionEdit()">Save</button>
                                    <button type="button" class="btn btn-secondary btn-sm"
                                        (click)="CancelVariableInfusionEdit()">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <div style="padding-left: 35px;" [hidden]="!iseditingadditionalconditions"
                            #additionalconditions>
                            <div class="row">
                                <div class="col-xs-12 headerlabeldiv mb-1 font-weight-bold">
                                    <label>
                                        <span>Additional Conditions</span>
                                    </label>
                                </div>
                            </div>
                            <div class="row mt-1" *ngFor="let ac of formsettings.additionalconditions">
                                <label>
                                    <input type="radio" formControlName="additionalconditions" [id]="ac.value"
                                        [value]="ac.value" #additionalconditionscontrol>
                                    <span class="ml-1">{{ac.name}}</span>
                                </label>
                            </div>
                            <div class="row" *ngIf="showInitialReminder && (!editingPrescription || clonePrescription)">
                                <div class="col-xs-12 headerlabeldiv mb-1  font-weight-bold">
                                    <label>
                                        <span>Reminder</span>
                                    </label>
                                </div>
                            </div>
                            <div class="row"
                                *ngIf="showInitialReminder  && (!editingPrescription || clonePrescription)">
                                <input type=" text" wholeNumber inputmode="numeric" placeholder="No. of"
                                    style="width:5em;" formControlName="reminderhours"
                                    [ngClass]="{'form-control':true}" />
                                <span class="mt-2 ml-1">hours
                                    after
                                    first administration</span>
                            </div>
                            <div class="row mt-1"
                                *ngIf="showInitialReminder  &&  (!editingPrescription || clonePrescription)">
                                <textarea maxlength="1024" rows="4" style="width:25em;" placeholder="Reminder text"
                                    formControlName="remindernotes" [ngClass]="{'form-control':true}"></textarea>
                            </div>
                            <div class="row mt-1"
                                *ngIf="showInitialReminder  &&  (!editingPrescription || clonePrescription)">
                                <label>
                                    <input type="checkbox" formControlName="reminderackrequired">
                                    <span class="ml-1">Make acknowledgement comment mandatory </span>
                                </label>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label class="text-danger" #acerror></label>
                                </div>
                            </div>
                            <div class="row float-right mr-1 mb-1 mt-1">
                                <div class="col float-right ">
                                    <button type="button" class="btn btn-info btn-sm mr-1"
                                        (click)="SaveAdditionalConditionsEdit()">Save</button>
                                    <button type="button" class="btn btn-secondary btn-sm"
                                        (click)="CancelAdditionalConditionsEdit()">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <div style="padding-left: 35px;" [hidden]="!iseditingchosendays" #chosendays>
                            <div class="row">
                                <div class="col-xs-12 headerlabeldiv mb-1 font-weight-bold">
                                    <label>
                                        <span>Chosen Days</span>
                                    </label>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <table>
                                    <tr>
                                        <td>
                                            <input formControlName="chosendays" type="radio" id="chosendays_all"
                                                value="all">
                                        </td>
                                        <td>
                                            <div class="ml-2">
                                                All Days</div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input formControlName="chosendays" type="radio" id="chosendays_chosen"
                                                value="chosen">
                                        </td>
                                        <td>
                                            <div [ngClass]="{'col-xs-12 ml-2':true, 'ck-button':true}">
                                                <label *ngFor="let d of formsettings.daysofweek">
                                                    <input
                                                        [disabled]="prescription['controls'].chosendays.value!='chosen'"
                                                        type="checkbox" [checked]="d.isChecked"
                                                        (change)="DaysOfWeekChanged($event,d)" [id]="d.value"
                                                        [value]="d.value" #daysofweekcheckbox>
                                                    <span>{{d.name}}</span>
                                                </label>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input formControlName="chosendays" type="radio" id="chosendays_skip"
                                                value="skip">
                                        </td>
                                        <td>
                                            <div class="row ml-2">
                                                <div class="col-xs-12 mt-1">
                                                    Every
                                                </div>
                                                <div class="col-xs-12 ml-1">
                                                    <input type="text" wholeNumber inputmode="numeric"
                                                        placeholder="No. of" style="width:5em;"
                                                        formControlName="dosingdaysfrequencysize"
                                                        [ngClass]="{'form-control':true}"
                                                        id=" txtdosingdaysfrequencysize" />
                                                </div>
                                                <div class="col-xs-12 ml-1">
                                                    <select class="form-control" formControlName="dosingdaysfrequency">
                                                        <option value="days">Days</option>
                                                        <option value="weeks">Weeks</option>
                                                        <option value="months">Months</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label class="text-danger" #chosendayserror></label>
                                </div>
                            </div>
                            <div class="row float-right mr-1 mb-1">
                                <div class="col float-right ">
                                    <button type="button" class="btn btn-info btn-sm mr-1"
                                        (click)="SaveChosenDaysEdit()">Save</button>
                                    <button type="button" class="btn btn-secondary btn-sm"
                                        (click)="CancelChosenDaysEdit()">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <div style="padding: 20px; padding-top: 0px;" [hidden]="!iseditinglinkedinfusion"
                            #linkedinfusion>
                            <div class="h5">Select an Infusion to link with this prescription <br><small>(This
                                    prescription
                                    can then be
                                    started
                                    only
                                    when the selected infusion ends) </small></div>
                            <div *ngFor="let p of therapyList">
                                <div (click)="SelectLinkedInfusion(p)" class="border mb-1"
                                    *ngIf="ShowInfusionForLinking(p)">
                                    <app-prescription-template [prescription]="p" componenttype="medicationOrderSet">
                                    </app-prescription-template>
                                </div>
                            </div>
                            <div *ngFor="let p of appService.Prescription">
                                <div (click)="SelectLinkedInfusion(p)" class="border mb-1"
                                    *ngIf="ShowInfusionForLinking(p)">
                                    <app-prescription-template [prescription]="p" componenttype="medicationOrderSet">
                                    </app-prescription-template>
                                </div>
                            </div>
                            <div class="row float-right mr-1 mb-1">
                                <div class="col float-right ">
                                    <button type="button" class="btn btn-secondary btn-sm"
                                        (click)="CancelLinkedInfusionSelection()">Cancel</button>
                                </div>
                            </div>
                        </div>


                        <ng-template #frequencytemplate let-ts='ts'>
                            <div formGroupName="posology">
                                <div formGroupName="interval">
                                    <div *ngIf="prescription['controls'].posology['controls'].interval['controls'].times_hours.value == 'x'"
                                        class="col-xs-12 ck-button">
                                        <label>
                                            <input formControlName="frequency" type="radio" id="interval_v_1X"
                                                value="1">
                                            <span>1X</span>
                                        </label>
                                        <label>
                                            <input formControlName="frequency" type="radio" id="interval_v_2X"
                                                value="2">
                                            <span>2X</span>
                                        </label>
                                        <label>
                                            <input formControlName="frequency" type="radio" id="interval_v_3X"
                                                value="3">
                                            <span>3X</span>
                                        </label>
                                        <label>
                                            <input formControlName="frequency" type="radio" id="interval_v_4X"
                                                value="4">
                                            <span>4X</span>
                                        </label>
                                    </div>
                                    <div *ngIf="prescription['controls'].posology['controls'].interval['controls'].times_hours.value == 'h'"
                                        class="col-xs-12 ck-button">
                                        <label>
                                            <input formControlName="frequency" type="radio" id="interval_v_6H"
                                                value="6">
                                            <span>6H</span>
                                        </label>
                                        <label>
                                            <input formControlName="frequency" type="radio" id="interval_v_8H"
                                                value="8">
                                            <span>8H</span>
                                        </label>
                                        <label>
                                            <input formControlName="frequency" type="radio" id="interval_v_12H"
                                                value="12">
                                            <span>12H</span>
                                        </label>
                                        <label>
                                            <input formControlName="frequency" type="radio" id="interval_v_24H"
                                                value="24">
                                            <span>24H</span>
                                        </label>
                                    </div>
                                    <div class="col-xs-12 ck-button">
                                        <input style="width: 50px;" wholeNumber inputmode="numeric"
                                            formControlName="customfrequency" (click)="ClearFrequency()" type="text"
                                            id="interval_v_custom">
                                    </div>
                                    <div class="col-xs-12 ck-button">
                                        <label for="interval_v_X">
                                            <input formControlName="times_hours" type="radio" id="interval_v_X"
                                                value="x"><span>
                                                X</span>
                                        </label>
                                        <label for="interval_v_H">
                                            <input formControlName="times_hours" type="radio" id="interval_v_H"
                                                value="h"><span>
                                                H</span>
                                        </label>
                                    </div>
                                </div>

                            </div>

                        </ng-template>

                        <ng-template #dosetemplate let-ts='ts' let-fs='fs' let-context='context'>
                            <div class="col">
                                <div class="row" *ngIf="fs.dose_type == 'units'" #dose_units>
                                    <div *ngIf="fs.interval_type!='protocol' && formsettings.isNeumeratorOnlyStrength && context != 'diluent'"
                                        class="col-xs-12">
                                        <input positiveNumberRange type="text" inputmode="numeric"
                                            (input)="ts.dose_totalstrength = $event.target.value"
                                            (change)="StrengthToUnitDose(ts,false,fs);RoundPrescribingDose(ts,fs);StrengthToUnitDose(ts,true,fs);Calculator_DosePerKgM2('1',ts,fs);FixDecimalPlaces(['dose_size','calculatorinput'],ts);"
                                            [value]="ts.dose_totalstrength ? ts.dose_totalstrength : ''"
                                            style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                            [ngClass]="{'form-control':true}" />
                                    </div>
                                    <div *ngIf="fs.interval_type!='protocol' && formsettings.isNeumeratorOnlyStrength && context != 'diluent'"
                                        class="col-xs-12 mr-1" style="margin-top: 0.5em;margin-left: 0.2em;">
                                        <label style="margin-top: 0.5em;"> {{fs.singleIngredientStrength}} </label>
                                    </div>
                                    <div class="col-xs-12">
                                        <input positiveNumberRange type="text" inputmode="numeric"
                                            (input)="ts.dose_size = $event.target.value"
                                            (change)="RoundPrescribingDose(ts,fs);VariableDoseSizeChanged();StrengthToUnitDose(ts,true,fs);Calculator_DosePerKgM2('1',ts,fs);FixDecimalPlaces(['dose_totalstrength','calculatorinput'],ts);"
                                            [value]="GetVariableDoseSizeInputText(ts)"
                                            style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                            [ngClass]="{'form-control':true, 'border-danger':IsDoseValid()}" />
                                    </div>
                                    <div *ngIf="fs.interval_type!='protocol'" class="col-xs-12"
                                        style="margin-top: 0.5em;margin-left: 0.2em;">
                                        <label style="margin-top: 0.5em;"> {{fs.dose_units}} </label>
                                    </div>
                                    <div formGroupName='posology'>
                                        <div formGroupName='strength'
                                            *ngIf="fs.interval_type!='protocol' && prescription['controls'].posology['controls'].strength['controls'].calculatortype.value!='null'"
                                            class="col-xs-12 ml-1">
                                            <input type="text" inputmode="numeric" positiveNumberRange
                                                (change)="Calculator_DosePerKgM2('2',ts,fs);RoundPrescribingDose(ts,fs);StrengthToUnitDose(ts,true,fs);FixDecimalPlaces(['dose_totalstrength','dose_size'],ts);"
                                                (input)="ts.calculatorinput = $event.target.value"
                                                [value]="ts.calculatorinput ? ts.calculatorinput : ''"
                                                style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                enterIsNext [ngClass]="{'form-control':true}" />
                                        </div>
                                    </div>
                                    <div *ngIf="fs.interval_type!='protocol' && prescription['controls'].posology['controls'].strength['controls'].calculatortype.value!='null'"
                                        class="col-xs-12" style="margin-top: 0.8em;margin-left: 0.2em;">
                                        <label> {{doseunitsdisplaytext}}
                                            <span
                                                *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'kg'">/kg/dose
                                                (<span
                                                    *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                    *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                Weight)</span>
                                            <span
                                                *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'ikg'">/kg/dose
                                                (Ideal body weight)</span>
                                            <span
                                                *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'm2'">/m2/dose</span>
                                        </label>
                                    </div>

                                </div>
                                <div class="row" *ngIf="fs.dose_type == 'strength'" #dose_strength>
                                    <table>
                                        <tr>
                                            <td [hidden]="context == 'diluent'" class="pl-2">
                                                <!-- the order of functions in change handler is important for proper rounding of all doses -->
                                                <input type="text" positiveNumbersOnly inputmode="numeric"
                                                    style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                    [value]="GetVariableDoseSNInputText(ts)"
                                                    class="btn-sm border rounded"
                                                    (input)="ts.dose_strength_neumerator = $event.target.value;"
                                                    (change)="CalculateTSVolumeFordose(ts,fs);RoundPrescribingDose(ts,fs);CalculateTSDoseForVolume(ts,fs);VariableDoseStrengthNMChagned();Calculator_DosePerKgM2('1',ts,fs);FixDecimalPlaces(['dose_strength_denominator','calculatorinput'],ts);" />
                                            </td>
                                            <td [hidden]="context == 'diluent'" *ngIf="fs.interval_type!='protocol'"
                                                style="margin-top: 0.5em;margin-left: 0.2em;">
                                                <label style="margin-top: 0.5em;"> {{fs.dose_strength_neumerator_units}}
                                                </label>
                                            </td>
                                            <td [hidden]="context == 'diluent'"> <label class="small text-muted"
                                                    style="margin-top: 0.5em;"> / </label>
                                            </td>
                                            <td>
                                                <!-- the order of functions in change handler is important for proper rounding of all doses -->
                                                <input type="text" positiveNumbersOnly inputmode="numeric"
                                                    style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                    class="btn-sm border rounded"
                                                    (input)="ts.dose_strength_denominator = $event.target.value;"
                                                    (change)="RoundPrescribingDose(ts,fs);CalculateTSDoseForVolume(ts,fs);VariableDoseStrengthDMChagned();Calculator_DosePerKgM2('1',ts,fs);DoseCalculations();FixDecimalPlaces(['dose_strength_neumerator','calculatorinput'],ts);"
                                                    [value]="GetVariableDoseSDInputText(ts)" />
                                            </td>
                                            <td *ngIf="fs.interval_type!='protocol'"
                                                style="margin-top: 0.5em;margin-left: 0.2em;">
                                                <label style="margin-top: 0.5em;">
                                                    {{fs.dose_strength_denominator_units}}
                                                </label>
                                            </td>
                                            <td>
                                                <span
                                                    *ngIf="fs.interval_type!='protocol' && prescription['controls'].posology['controls'].strength['controls'].calculatortype.value!='null'"
                                                    class="ml-2">
                                                    <!-- the order of functions in change handler is important for proper rounding of all doses -->

                                                    <input type="text" inputmode="numeric" positiveNumbersOnly
                                                        (change)="Calculator_DosePerKgM2('2',ts,fs);CalculateTSVolumeFordose(ts,fs); RoundPrescribingDose(ts,fs);CalculateTSDoseForVolume(ts,fs);DoseCalculations();;FixDecimalPlaces(['dose_strength_neumerator','dose_strength_denominator'],ts);"
                                                        style="width: 80px;padding-right: 0px;padding-left: 0px;text-align: center;"
                                                        (input)="ts.calculatorinput = $event.target.value"
                                                        [value]="ts.calculatorinput ? ts.calculatorinput : ''"
                                                        enterIsNext class="btn-sm border rounded" />
                                                </span>
                                                <span
                                                    *ngIf="fs.interval_type!='protocol' && prescription['controls'].posology['controls'].strength['controls'].calculatortype.value!='null'"
                                                    style="margin-top: 0.8em;margin-left: 0.2em;">
                                                    <label> {{doseunitsdisplaytext}}
                                                        <span
                                                            *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'kg'">/kg/dose
                                                            (<span
                                                                *ngIf="appService.refWeightType && appService.refWeightType == 'estimated' ">Estimated</span><span
                                                                *ngIf="!appService.refWeightType || appService.refWeightType == 'actual' ">Actual</span>
                                                            Weight)</span>
                                                        <span
                                                            *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'ikg'">/kg/dose
                                                            (Ideal body weight)</span>
                                                        <span
                                                            *ngIf="prescription['controls'].posology['controls'].strength['controls'].calculatortype.value == 'm2'">/m2/dose</span>
                                                    </label>
                                                </span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="row" *ngIf="fs.dose_type == 'descriptive'" #dose_descriptive>
                                    <div class="col-xs-12" style="width: 95%;">
                                        <input placeholder="Instructions for taking"
                                            (input)="ts.dose_description = $event.target.value"
                                            [value]="GetVariableDoseDescInputText(ts)"
                                            style="height: 30px; font-size: 80%; width:30em;"
                                            [ngClass]="{'form-control':true, 'border-danger':IsDoseValid()}" />
                                    </div>
                                </div>
                            </div>
                        </ng-template>

                    </form>
                </div>
                <div *ngIf="!formsettings || (formsettings && !formsettings.medication)">
                    <span class="ml-3">Loading, please wait </span>
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <button type="button" class="m-2 mt-4 float-right btn btn-secondary btn-sm"
                        (click)="CancelPrescription()">Cancel</button>
                </div>
                <div *ngIf="formsettings && formsettings.medication && !formsettings.medication.detail.prescribable">
                    <div class="col">
                        <label class="alert-danger h6 rounded" #vtmdoseerror>
                            This medication is not prescribable.
                        </label>
                        <label class="alert-danger h6 rounded" *ngIf="this.formsettings.routes.length == 0">
                            No routes of administration have been configured for this product, please contact your IT
                            support desk.
                        </label>

                        <button type="button" class="m-2 mt-4 float-right btn btn-secondary btn-sm"
                            (click)="CancelPrescription()">Close</button>
                    </div>

                </div>

            </div>
            <div>
                <button type="button" hidden data-dismiss="modal" #close_pform>Close</button>
            </div>
        </div>
    </div>
    <!-- <div *ngIf="formsettings && formsettings.medication">

        isPrimaryRouteIV: {{formsettings.isPrimaryRouteIV}}<br>
        isInfusion: {{formsettings.isInfusion}}<br>
        vtmstyle:{{formsettings.vtmstyle}}
    </div> -->
</div>


<button type="button" hidden data-toggle="modal" data-target="#pform" data-backdrop="static" data-keyboard="false"
    #open_pform></button>